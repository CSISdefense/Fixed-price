---
title: 'DoD Fixed-Price Study: Contract Vehicle Classification'
author: "Greg Sanders"
date: "Tuesday, January 13, 2015"
output:
  html_document:
    keep_md: yes
    toc: yes
---

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(plyr)
require(Hmisc)
options(error=recover)
setwd("K:\\Development\\Fixed-price")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))

```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the [exploration on R&D](RnD_1to5_exploration.md), we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

##Studying contract vehicle within the sample.
Describe contract vehicle here.

```{r setup, echo = TRUE}
ContractSample  <- read.csv(
    paste("data\\defense_contract_CSIScontractID_sample_100000_SumofObligatedAmount.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )

#These will probably be moved into apply_lookups at some point

ContractSample$pIsFixedPrice <- ContractSample$ObligatedAmountIsFixedPrice/ContractSample$SumofObligatedAmount
ContractSample$pIsFixedPrice[is.nan(ContractSample$ObligatedAmountIsFixedPrice)|is.na(ContractSample$ObligatedAmountIsFixedPrice)] <- 0

ContractSample$pIsCostBased <- ContractSample$ObligatedAmountIsCostBased/ContractSample$SumofObligatedAmount
ContractSample$pIsCostBased[is.nan(ContractSample$ObligatedAmountIsCostBased)|is.na(ContractSample$ObligatedAmountIsCostBased)] <- 0

ContractSample$pIsCombination <- ContractSample$ObligatedAmountIsCombination/ContractSample$SumofObligatedAmount
ContractSample$pIsCombination[is.nan(ContractSample$ObligatedAmountIsCombination)|is.na(ContractSample$ObligatedAmountIsCombination)] <- 0

ContractSample$pIsInternational <- ContractSample$ObligatedAmountIsInternational/ContractSample$SumofObligatedAmount
ContractSample$pIsInternational[is.na(ContractSample$ObligatedAmountIsInternational)] <- 0

ContractSample$AnyInternational<-factor(ContractSample$AnyInternational,
                                        exclude=NULL,
                                        levels=c(0,1,NA),
                                        labels=c("Just U.S.","Any\nInternational","Unlabeled")
                                        )



ContractSample$UnmodifiedDays<-as.numeric(difftime(strptime(ContractSample$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
                                                     , strptime(ContractSample$MinOfEffectiveDate,"%Y-%m-%d")
                                                     , unit="days"
        ))+1



                               
ContractSample<-apply_lookups(Path,ContractSample)




summary(subset(ContractSample,select=c(UnmodifiedIsSomeCompetition,
                                IsIDV,
                                IsFixedPrice,
                                IsCostBased,
                                UnmodifiedIsFullAndOpen,
                                ##Number connected
                                AnyInternational,
                                SimpleArea,
                                UnmodifiedContractBaseAndAllOptionsValue,
                                UnmodifiedDays,
                                UnmodifiedNumberOfOffersReceived
                                ))
        )

```
Describe source variables in FPDS here.

###Limiting the sample.

Because this model analyzes the number of offers on competed contracts, the first step is eliminating contracts that were not competed. This is done using the UnmodifiedIsSomeCompetetion field (see [competition exploration](contract_competition_exploration.md) for variable details). This variable has an unlabeled rate of `r sprintf("%1.2f%%",nrow(subset(ContractSample,UnmodifiedIsSomeCompetition=="Unlabeled")) /nrow(ContractSample)*100)`. As is done throughout the model, if all labeled values for the contract have are consistent, then that value is used to fill in for the blanks.

```{r ImputingForIsSomeCompetition, echo = TRUE}

#Impute missing values when labeled entries have a consistent value.
NAisSomeCompetition<-ContractSample$UnmodifiedIsSomeCompetition=="Unlabeled"&ContractSample$IsSomeCompetition!="Mixed or \nUnlabeled"
ContractSample$UnmodifiedIsSomeCompetition[NAisSomeCompetition]<-ContractSample$IsSomeCompetition[NAisSomeCompetition]
rm(NAisSomeCompetition)
```

After imputed, UnmodifiedIsSomeCompetition has a `r sprintf("%1.2f%%",nrow(subset(ContractSample,UnmodifiedIsSomeCompetition=="Unlabeled")) /nrow(ContractSample)*100)` missing data rate. This variable can now be used to narrow the sample.

```{r competedonly, echo = TRUE}
ContractSample<-ContractSample[ContractSample$UnmodifiedIsSomeCompetition=="Comp.",]
summary(subset(ContractSample,select=c(UnmodifiedIsSomeCompetition,
                                IsIDV,
                                IsFixedPrice,
                                IsCostBased,
                                UnmodifiedIsFullAndOpen,
                                ##Number connected
                                AnyInternational,
                                SimpleArea,
                                UnmodifiedContractBaseAndAllOptionsValue,
                                UnmodifiedDays,
                                UnmodifiedNumberOfOffersReceived
                                ))
        )


```


###Evidence variables
Note that these missing data rates are only for competed entries, so they will typically not match the overall unlabeled rates.

 * IsIDV is a classification for the entirity of the contract  (`r sprintf("%1.2f%%",nrow(subset(ContractSample,is.na(IsIDV))) /nrow(ContractSample)*100)` missing data). See [vehicle exploration](contract_vehicle_exploration.md) for more. Since this variable is consistently labeled, it isn't necessary to impute data or seperate out unmodified entries.
 * UnmodifiedIsFullAndOpen is the classification given by the first record for the contract (`r sprintf("%1.2f%%",nrow(subset(ContractSample,is.na(UnmodifiedIsFullAndOpen)|UnmodifiedIsFullAndOpen=="Unlabeled")) /nrow(ContractSample)*100)` missing data). See [exploration on competition](contract_competition_exploration.md) for more.
 * UnmodifiedNumberOfOffersReceived reports the Number of Offers received according to the first reported transaction under a contract (`r sprintf("%1.2f%%",nrow(subset(ContractSample,is.na(UnmodifiedNumberOfOffersReceived)|UnmodifiedNumberOfOffersReceived==0)) /nrow(ContractSample)*100)` missing data, far too high, there must be a SQL mistake). See [exploration on competition](contract_competition_exploration.md) for more.
* simplearea is a classification for the entirity of the contract  (`r #sprintf("%1.2f%%",nrow(subset(ContractSample,SimpleArea=="Mixed or Unlabeled")) /nrow(ContractSample)*100)` missing data). See [exploration on product, service, and R&D](contract_ProductServiceRnD_exploration.md) for more.



```{r overallvars, echo = TRUE}


ContractSample$FixedOrCost[ContractSample$pIsFixedPrice>0  |
                                      ContractSample$pIsCostBased>0 | 
                                          ContractSample$pIsCombination>0]<-"Combination \nor Other"

ContractSample$FixedOrCost[ContractSample$pIsFixedPrice>=0.95|(ContractSample$IsFixedPrice=="Fixed Price" & ContractSample$pIsCombination==0)]<-"Fixed-Price"
ContractSample$FixedOrCost[ContractSample$pIsCostBased>=0.95|(ContractSample$IsCostBased==1 & ContractSample$pIsCombination==0)]<-"Cost-Based"
ContractSample$FixedOrCost<-factor(ContractSample$FixedOrCost,levels=c("Fixed-Price","Cost-Based","Combination \nor Other"))

ContractSample$AnyInternational[ContractSample$pIsInternational<=0 & 
                    ContractSample$AnyInternational=="Any\nInternational" &
                    ContractSample$UnmodifiedIsInternational==0]<-"Just U.S."

NASimpleArea<-ContractSample$SimpleArea=="Mixed or Unlabeled"&!is.na(ContractSample$UnmodifiedSimpleArea)
ContractSample$SimpleArea[NASimpleArea]<-ContractSample$UnmodifiedSimpleArea[NASimpleArea]
ContractSample$SimpleArea[ContractSample$SimpleArea=="Mixed or Unlabeled" & ContractSample$pIsProducts>0.5]<-"Products"
ContractSample$SimpleArea[ContractSample$SimpleArea=="Mixed or Unlabeled" & ContractSample$pIsServices>0.5]<-"Services"
ContractSample$SimpleArea[ContractSample$SimpleArea=="Mixed or Unlabeled" & ContractSample$pIsRnD>0.5]<-"R&D"


roundedcutoffs<-c(15000,100000,1000000,30000000)
ContractSample$qCeiling<-cut2(ContractSample$UnmodifiedContractBaseAndAllOptionsValue,cuts=roundedcutoffs)

#Impute missing values
NAisFullAndOpen<-is.na(ContractSample$UnmodifiedIsFullAndOpen)
ContractSample$UnmodifiedIsFullAndOpen[NAisFullAndOpen]<-ContractSample$IsFullAndOpen[NAisFullAndOpen]
rm(NAisFullAndOpen)

ContractSample$qDuration<-cut2(ContractSample$UnmodifiedDays,cuts=c(61,221,366))

NAnumberOfOffers<-is.na(ContractSample$UnmodifiedNumberOfOffersReceived)&!is.na(ContractSample$NumberOfOffersReceived)
ContractSample$UnmodifiedNumberOfOffersReceived[NAnumberOfOffers]<-ContractSample$NumberOfOffersReceived[NAnumberOfOffers]
rm(NAnumberOfOffers)

summary(subset(ContractSample,select=c(UnmodifiedIsSomeCompetition,
                                IsIDV,
                                FixedOrCost,
                                UnmodifiedIsFullAndOpen,
                                ##Number connected
                                AnyInternational,
                                SimpleArea,
                                qCeiling,
                                qDuration,
                                UnmodifiedNumberOfOffersReceived
                                ))
        )

```

After imputing using consistent labeled entries where available.
 * UnmodifiedIsFullAndOpen has (`r sprintf("%1.2f%%",nrow(subset(ContractSample,is.na(UnmodifiedIsFullAndOpen)|UnmodifiedIsFullAndOpen=="Unlabeled")) /nrow(ContractSample)*100)` missing data).
 * UnmodifiedNumberOfOffersReceived has (`r sprintf("%1.2f%%",nrow(subset(ContractSample,is.na(UnmodifiedNumberOfOffersReceived)|UnmodifiedNumberOfOffersReceived==0)) /nrow(ContractSample)*100)` missing data.

