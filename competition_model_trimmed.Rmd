---
output:
  html_document:
    keep_md: yes
--- 

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(graph)
require(plyr)
require(Hmisc)
require(Matrix)
require(gRain)
require(gRbase)
require(methods)
require(bnlearn)
require(Rgraphviz)
#source("http://bioconductor.org/biocLite.R");
#biocLite("Rgraphviz")
# biocLite("RBGL")
setwd("K:\\Development\\Fixed-price")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))



```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the [exploration on R&D](RnD_1to5_exploration.md), we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

##Studying contract vehicle within the sample.
Describe contract vehicle here.

```{r setup, echo = TRUE}
setwd("K:\\Development\\Fixed-price\\")
filename<-"data\\defense_contract_CSIScontractID_model.csv"



ContractModel  <- read.csv(
    filename,
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )
ContractModel<-subset(ContractModel,select=-c(SingleOffer))

nrow(ContractModel)
nrow(subset(ContractModel,complete.cases(ContractModel)))
summary(subset(ContractModel,complete.cases(ContractModel)))

dropped<-subset(ContractModel,!complete.cases(ContractModel)|
                    Intl=="Unlabeled"|
                    PSR =="Mixed or Unlabeled" |
                    Who=="Uncategorized" |
                    What =="Unlabeled")

ContractModel<-subset(ContractModel,complete.cases(ContractModel)&
                          Intl!="Unlabeled"&
                          PSR !="Mixed or Unlabeled"&
                          Who!="Uncategorized" & 
                          What!="Unlabeled")

ContractModel$Intl<-droplevels(ContractModel$Intl)
ContractModel$PSR<-droplevels(ContractModel$PSR)
ContractModel$Who<-droplevels(ContractModel$Who)
ContractModel$What<-droplevels(ContractModel$What)

nrow(ContractModel)
```

The last stage before Bayesian learning is setting the whitelists and blacklists. The whitelist contains vectors that must existing in the graph while the blacklist contains forbidden vectors. There was some iteration in the development of the white and blacklist, as nonsensical connections were removed and the blacklist was made systematic.

I've listed them below based on the origin piece of evidence.
1. IDV (IsIDV)
* Whitelist to Comp (Competition) as many forms of IDVs don't qualify for full and open.
* Blacklist to PSR (SimpleArea) because what you are buying is picked before how you are buying it.
2. FxCb (FixedOrCost)
* Whitelist to One (SingleOffer) as this is the key study question.
* Blacklist to PSR (SimpleArea) and Intl (AnyInternational) because figuring out what and where come first.
* Blacklist to Ceil (qCeiling) and Dur (qDuration), because project scope should come before project pricing,  although this may not be entirely true when the vendors make proposals.
3. Comp (Competition)  
* Whitelist to One (SingleOffer). We'll see how strong this connection ends up being, but it's really straightforward.
* Blacklist to PSR (SimpleArea),  Intl (AnyInternational), and FxCb (FixedOrCost), as I think those details are set before deciding competition procedures.
4. Intl (AnyInternational) No restrictions or requirements.
5. PSR (SimpleArea)
* Blacklist to Intl (AnyInternational) As I think the place of performance in the U.S. or abroad (but not the vendor location) is sometimes decided at least as early as the  product or service.
6. Ceil (qCeiling)
* Blacklist to PSR (SimpleArea) Intl (AnyInternational) because what and where come before scope.
7. Dur (qDuration)
* Blacklist to PSR (SimpleArea) Intl (AnyInternational) because what and where come before scope.
8. One (SingleOffer) 
* Blacklist to everything not covered by an existing whitelist. While the vendors responses may influence some factors at the margin, this is the dependent variable for this part of the study.

```{r BayesianLearningSetup, echo = TRUE}

#White list, connections that must occur
ContractWL<-data.frame(from="Comp",to="Offr")
# ContractWL<-rbind(ContractWL,data.frame(from="Comp",to="Offr"))
ContractWL<-rbind(ContractWL,data.frame(from="PSR",to="FxCb"))
ContractWL<-rbind(ContractWL,data.frame(from="PSR",to="Link"))
ContractWL<-rbind(ContractWL,data.frame(from="FxCb",to="Offr"))
ContractWL<-rbind(ContractWL,data.frame(from="What",to="Link"))
# ContractWL<-rbind(ContractWL,data.frame(from="Who",to="Intl"))
ContractWL<-rbind(ContractWL,data.frame(from="Who",to="What"))
ContractWL<-rbind(ContractWL,data.frame(from="IDV",to="Ceil"))
ContractWL<-rbind(ContractWL,data.frame(from="Ceil",to="FxCb"))

bnWhitelist <- empty.graph(nodes = names(ContractModel))
arcs(bnWhitelist)<-ContractWL
graphviz.plot(bnWhitelist,main="Whitelisted Arcs Rd. 1")



#Black list, connections that are prohibited
ContractBL<-data.frame(from=c("Offr"),to= c("IDV"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="PSR"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="FxCb"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="Ceil"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="Dur"))
ContractBL<-rbind(ContractBL,data.frame(from="Offr",to="Link"))
# ContractBL<-rbind(ContractBL,data.frame(from="Who",to="Offr"))
ContractBL<-rbind(ContractBL,data.frame(from="Link",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="Link",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="Link",to="IDV"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Ceil"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Dur"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Link"))
ContractBL<-rbind(ContractBL,data.frame(from="FxCb",to="Comp"))
ContractBL<-rbind(ContractBL,data.frame(from="Ceil",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="Ceil",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="Ceil",to="PSR"))
ContractBL<-rbind(ContractBL,data.frame(from="Ceil",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="Ceil",to="Link"))
ContractBL<-rbind(ContractBL,data.frame(from="Dur",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="Dur",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="Dur",to="PSR"))
ContractBL<-rbind(ContractBL,data.frame(from="Dur",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="Dur",to="Link"))
ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="PSR"))
ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="Link"))
ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="Intl"))


ContractBL<-rbind(ContractBL,data.frame(from="PSR",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="PSR",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="PSR",to="Intl"))

ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="Who"))
ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="What"))
ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="PSR"))
ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="Intl"))
ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="Comp"))


# ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="Ceil"))
# ContractBL<-rbind(ContractBL,data.frame(from="Comp",to="Dur"))

ContractBL<-rbind(ContractBL,data.frame(from="IDV",to="Link"))


ContractBL<-rbind(ContractBL,data.frame(from="Who",to="Comp"))
ContractBL<-rbind(ContractBL,data.frame(from="Who",to="Offr"))
ContractBL<-rbind(ContractBL,data.frame(from="Who",to="IDV"))
ContractBL<-rbind(ContractBL,data.frame(from="Who",to="FxCb"))
ContractBL<-rbind(ContractBL,data.frame(from="Who",to="Ceil"))
ContractBL<-rbind(ContractBL,data.frame(from="Who",to="Dur"))


df <- data.frame(from=ContractBL$from, to=ContractBL$to, weight=rep(1,nrow(ContractBL)))
g1 <- graphBAM( data.frame(from=ContractBL$from, to=ContractBL$to, weight=rep(1,nrow(ContractBL))),
                edgemode = "directed")
adjacencyMatrix(g1)
plot(g1,main="Competition Bayesian Network Blacklist")
edgeNames(g1)
eAttrs<-list()
eAttrs$color<-c("Ceil~Intl"="red",
                "Ceil~Link"="red",
                "Ceil~PSR"="red",
                "Ceil~What"="red",
                "Ceil~Who"="purple",
                "Comp~Intl"="red",
                "Comp~Link"="red",
                "Comp~PSR"="red",
                "Comp~What"="red",
                "Comp~Who"="purple",
                "Dur~Intl"="red",
                "Dur~Link"="red",
                "Dur~PSR"="red",
                "Dur~What"="red",
                "Dur~Who"="purple",
                "FxCb~Ceil"="red",
                "FxCb~Comp"="red",
                "FxCb~Dur"="red",
                "FxCb~Intl"="red",
                "FxCb~Link"="red",
                "FxCb~What"="red",
                "FxCb~Who"="purple",
                "IDV~Intl"="red",
                "IDV~Link"="purple",
                "IDV~PSR"="red",
                "IDV~What"="red",
                "IDV~Who"="purple",
                "Link~Intl"="red",
                "Link~Who"="red",
                "Offr~Ceil"="red",
                "Offr~Dur"="red",
                "Offr~FxCb"="red",
                "Offr~IDV"="red",
                "Offr~Intl"="red",
                "Offr~Link"="red",
                "Offr~PSR"="red",
                "Offr~What"="red",
                "Offr~Who"="purple",
                "PSR~Intl"="red",
                "PSR~What"="red",
                "PSR~Who"="red"  )

plot(g1,
     main="Competition Bayesian Network Blacklist\nOne-way Blocks in Red, Two-way Blocks in Purple",
     edgeAttrs=eAttrs)


```

After the team developed the initial list and a small number of elements accidentally left off were corrected for, the next step was to do a preliminary run through with Bayesian learning. 



Noteably this initial run through produced two warnings of challenging relationships IDV to Dur and IDV to FxCb. After consulting within the team, the choice was made to add whitelisted relationships that went against those automatically produced.

IDV (IsIDV) new white lists:
* Whitelist to FxCb (FixedOrCost) because the pricing mechanism of most IDVs are set. Thus, once the choice of which IDV to use is made, the pricing mechanism would be set automatically. Furthermore, Fixed-price is often the mechanism because the IDV allows for multiple instances of a single contract reducing the need for the flexabilit Cost-Based contracts offer.
* Whitelist to Dur (Duration) because the use of the IDV mechanism typically means multiple shorter contractors under one IDV rather than a single longer contract. 

With those two connections in hand, all three Bayesian Learning algorith were applied.

```{r BayesianExecution, echo = TRUE}
#White list, connections that must occur
# ContractWL<-rbind(ContractWL,data.frame(from="IDV",to="Dur"))
# ContractWL<-rbind(ContractWL,data.frame(from="IDV",to="FxCb"))

# ContractWL<-rbind(ContractWL,data.frame(from="Dur",to="Ceil"))
# ContractWL<-rbind(ContractWL,data.frame(from="Ceil",to="Comp"))
# ContractWL<-rbind(ContractWL,data.frame(from="Ceil",to="Dur"))


# 
# 
# highlightWL2 <- list(arcs = ContractWL, col = "blue")
# 
# highlightLists2 <- list(arcs = data.frame(from=c(as.character(ContractWL$from),
#                                                  as.character(ContractBL$to)),
#                                           to=c(as.character(ContractWL$to),
#                                                as.character(ContractBL$from))),
#                         col = "blue")
# 
# 
# 
# 
# iamb_dug<-iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=TRUE, alpha=0.001)
# uiamb_dug<-iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE, alpha=0.001)
# #Comparing the optimized and unoptimized Incremental Association results
# all.equal(iamb_dug,uiamb_dug)
# 
# interiamb_dug<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL, alpha=0.001)
# uinteriamb_dug<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE, alpha=0.001)
# #They also dont match with interleaved.
# all.equal(interiamb_dug,uinteriamb_dug)
# all.equal(uiamb_dug,uinteriamb_dug)
# 
# mmpc_dug<-mmpc(ContractModel)
# ummpc_dug<-mmpc(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE)
# #They also dont match with interleaved.
# all.equal(mmpc_dug,ummpc_dug)
# 
# gs_dug<-gs(ContractModel,blacklist=ContractBL,whitelist=ContractWL,alpha=0.001)
# 
# #But the two methods do not producing matching results
# all.equal(iamb_dug,interiamb_dug)
# all.equal(uiamb_dug,uinteriamb_dug)
# all.equal(uiamb_dug,mmpc_dug)
# 
# 
# uinteriamb_dug05<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE,alpha=0.05)
# 
# hc_dug<- hc(ContractModel, score = "aic",blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE)
# graphviz.plot(hc_dug,main="Hill Climbing Whitelist highlighted",highlight=highlightWL2)
# graphviz.plot(hc_dug,main="Hill Climbing Whitelist Interleaved highlighted  ",highlight=list(arcs=arcs(uinteriamb_dug)))
# graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Hillclimbing highlighted",highlight=list(arcs=arcs(hc_dug)))
# 
# 
# graphviz.plot(uiamb_dug,main="Unoptimized Incremental Association ",highlight=highlightWL2)
# graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Incremental Association ",highlight=highlightWL2)
# graphviz.plot(mmpc_dug,main="MMPC ",highlight=highlightWL2)
# 
# # graphviz.plot(uiamb_dug,main="Unoptimized Incremental Association ",highlight=arcs(uinteriamb_dug))
# 
# graphviz.plot(gs_dug,main="Grow-Shrink 2nd run",highlight=highlightWL2)
# 
# #Comparing the optimized and unoptimized Interleaved Incremental Association results
# 
# uinteriamb_dug00001<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE,alpha=0.000001)
# all.equal(uinteriamb_dug,uinteriamb_dug00001)
# 
# 
# modelstring(uinteriamb_dug00001)
# modelstring(uinteriamb_dug)
# modelstring(interiamb_dug)
# modelstring(uiamb_dug)
# modelstring(iamb_dug)
# modelstring(hc_dug)
# modelstring(gs_dug)
# 
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][FxCb|PSR][Comp|What:Intl:PSR][Link|Who:What:Intl:PSR][IDV|Comp:What:Intl:PSR][Ceil|IDV:What:Intl:PSR][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:Link:What:Intl:Ceil]"
# # > modelstring(uinteriamb_dug00001)
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][FxCb|PSR][Comp|What:Intl:PSR][Link|Who:What:Intl:PSR][IDV|Comp:What:Intl:PSR][Ceil|IDV:What:Intl:PSR][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:Link:What:Intl:Ceil]"
# # > modelstring(uinteriamb_dug)
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][FxCb|PSR][Comp|What:Intl:PSR][Link|Who:What:Intl:PSR][IDV|Comp:What:Intl:PSR][Ceil|IDV:What:Intl:PSR][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:Link:What:Intl:Ceil]"
# # > modelstring(interiamb_dug)
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][FxCb|PSR][Comp|What:Intl:PSR][Link|Who:What:Intl:PSR][IDV|Comp:What:Intl:PSR][Ceil|IDV:What:Intl:PSR][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:Link:What:Intl:Ceil:Dur]"
# # > modelstring(uiamb_dug)
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][Link|Who:What:Intl:PSR][Comp|Link:What:Intl:PSR][IDV|Comp:What:PSR][Ceil|IDV:What:Intl:PSR][FxCb|PSR:Ceil][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:What:Intl]"
# # > modelstring(iamb_dug)
# # [1] "[Who][What|Who][Intl|Who:What][PSR|Who:What:Intl][Link|Who:What:Intl:PSR][Comp|Link:What:Intl:PSR][IDV|Comp:What:PSR][Ceil|IDV:What:Intl:PSR][FxCb|PSR:Ceil][Dur|IDV:Comp:Link:What:Intl:PSR:Ceil][Offr|IDV:FxCb:Comp:What:Intl:Dur]"
# # > modelstring(hc_dug)
# # [1] "[Who][Intl|Who][What|Who:Intl][PSR|Who:What:Intl][Link|Who:What:Intl:PSR][Comp|Link:What:Intl:PSR][Dur|Comp:Link:What:Intl:PSR][IDV|Comp:What:Intl:PSR:Dur][Ceil|IDV:Comp:Link:What:Intl:PSR:Dur][FxCb|IDV:Comp:Link:What:PSR:Ceil:Dur][Offr|IDV:FxCb:Comp:What:Intl:PSR:Ceil:Dur]"
# # graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Incremental 001 Association 00001 highlighted",highlight=list(arcs=arcs(uinteriamb_dug00001)))
# # graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Incremental Association Optimized highlighted",highlight=list(arcs=arcs(interiamb_dug)))
# # graphviz.plot(interiamb_dug,main="optimized Interleaved Incremental Association UnOptimized highlighted",highlight=list(arcs=arcs(uinteriamb_dug)))
# 
# graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Incremental Association IAMB highlighted",highlight=list(arcs=arcs(uiamb_dug)))
# 
# graphviz.plot(iamb_dug,main="Unoptimized Incremental Association Unoptimized IAMB highlighted",highlight=list(arcs=arcs(uiamb_dug)))
# graphviz.plot(uiamb_dug,main="optimized Incremental Association IAMB highlighted",highlight=list(arcs=arcs(iamb_dug)))



```
To the study teams dismay, the bayesian learning results were not consistent across different methods. The unoptimized versions of the learning algorithms do better at catching statistical oddities at the cost of requiring more comparisons. After analyzing the unoptimized and optimized versions, the team chose to adopt one arc that appeared in the both unoptimized versions, namely duration to offers. Seperate analysis shown in the Contract_Competition found that longer contracts did have fewer offers even after controlling for contract ceiling.

Similarly, the grow shrink algorithm included a link from Ceil to FxCb. Analysis shown in Contract_Pricing holds up that connection, even after controlling for PSR. This does not appear to be true of duration or competition. There may well be a link between IDV and Fixed-price, but there's enough complexity in the causality in that relationship that the team chose not to force it.

* Whitelist Ceil (Ceil) to FxCb because higher ceiling contracts are more likely to be cost-based or combination.

Dur (Duration) to Number of Offers received (Offr) was considered, but this ended up resulting in the Ceil to Dur being lost. Of the two, Ceil has the more straightforward relationship, so it was kept. 


The other alternative within the package, a min-max parents and childrens approach, 


```{r BayesianExecutionRd3, echo = TRUE}



highlightWL3 <- list(arcs = ContractWL, col = "blue")

highlightLists3 <- list(arcs = data.frame(from=c(as.character(ContractWL$from),
                                                 as.character(ContractBL$to)),
                                          to=c(as.character(ContractWL$to),
                                               as.character(ContractBL$from))),
                        col = "blue")

uinteriamb3_dug00001<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE,alpha=0.000001)
# uinteriamb3_dug<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE,alpha=0.001)
# 
# uinteriamb3_dug05<-inter.iamb(ContractModel,blacklist=ContractBL,whitelist=ContractWL,optimized=FALSE,alpha=0.05)
# 
# all.equal(uinteriamb_dug,uinteriamb3_dug00001)
# 
# graphviz.plot(uinteriamb_dug00001,main="Unoptimized Interleaved Incremental Association Whitelist highlighted",highlight=highlightWL3)
# graphviz.plot(uinteriamb_dug00001,main="Unoptimized Interleaved Incremental Association either list highlighted",highlight=highlightLists3)
# graphviz.plot(uinteriamb_dug00001,main="Unoptimized Interleaved Incremental Association IAMB highlighted",highlight=list(arcs=arcs(uiamb_dug)))
# # graphviz.plot(uiamb_dug,main="Unoptimized Interleaved Incremental Association ",highlight=list(arcs=arcs(uinteriamb_dug)))
# graphviz.plot(uinteriamb_dug,main="Unoptimized Interleaved Incremental Association IAMB highlighted",highlight=list(arcs=arcs(uinteriamb3_dug00001)))
# graphviz.plot(uinteriamb3_dug00001,main="Unoptimized Interleaved Incremental Association IAMB highlighted",highlight=list(arcs=arcs(uinteriamb_dug)))
# graphviz.plot(uinteriamb3_dug,main="Unoptimized Interleaved Incremental Association IAMB highlighted",highlight=list(arcs=arcs(uinteriamb_dug)))


# uinteriamb3_dug00001<-set.arc(uinteriamb3_dug00001,"Ceil","Offr")
# uinteriamb3_dug00001<-drop.arc(uinteriamb3_dug00001,"Dur","Offr")

graphviz.plot(uinteriamb3_dug00001,main="Initial Number of Offers Bayesian Network",highlight=highlightWL3)


ContractModel$Offr<-factor(ContractModel$Offr, 
                           levels=c("  1","  2","[  3,  5)","[  5,999]"),
                           labels=c("1","2","3-4","5+"),
                           ordered=TRUE
                           )

ContractModel$Ceil<-factor(ContractModel$Ceil,
                                        levels=c("[0.00e+00,1.50e+04)"
                                                 ,"[1.50e+04,1.00e+05)"
                                                 ,"[1.00e+05,1.00e+06)"
                                                 ,"[1.00e+06,3.00e+07)"
                                                 ,"[3.00e+07,3.36e+12]"
                                                 ),
                                        labels=c("[0,15k)"
                                                 ,"[15k,100k)"
                                                 ,"[100k,1m)"
                                                 ,"[1m,30m)"
                                                 ,"[30m+]"
                                                 ),
                                        ordered=TRUE)

```


```{r BayesianCompilation, echo = TRUE}
CompetitionNetwork<-uinteriamb3_dug00001
modelstring(CompetitionNetwork)

# CompetitionFitted<-bn.fit(x=CompetitionNetwork,data=ContractModel,method="bayes")
# summary(ContractModel)
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Fixed-Price") & (Comp=="Comp."))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp."))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="[0,15k)"))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="[15k,100k)"))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="[100k,1m)"))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="[1m,30m)"))
# cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="[30m+]"))
# 
# y<-paste("Ceil=='",levels(ContractModel$Ceil),"'",sep="")
# 
# sapply(levels(ContractModel$Ceil),function(x) eval(sprintf('cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil=="%s")',x)))
# 
# sapply(levels(ContractModel$Ceil),FixedPriceTest)

# FixedPriceTest("[30m+]")
# 
# FixedPriceTest<-function(x){
#     cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp.") & (Ceil==x)
#         )
# }
# 
# eval("cpquery(CompetitionFitted, \n        event =  (Offr==\"1\"),\n        evidence = (FxCb==\"Cost-Based\") & (Comp==\"Comp.\") & (Ceil==\"[30m+]\")")
# levels(ContractModel$Ceil)
# 
# sapply(levels(ContractModel$Ceil),function(x) paste(x,"")) 
# 
# sapply(c(1,2,3),function(x)   cpquery(CompetitionFitted, 
#         event =  (Offr=="1"),
#         evidence = (FxCb=="Cost-Based") & (Comp=="Comp."))) (Ceil==x) &  (Ceil==x)) #& (Ceil==x)
# 

require(gRain)
# cad.cpt <- extractCPT(ContractModel, as.graphNEL(CompetitionNetwork), smooth = 0.001)
# compGin <- grain(compileCPT(cad.cpt))

compGin <- grain(as.graphNEL(CompetitionNetwork), data=ContractModel, smooth = 0.0000001)
summary(compGin)
# 
# str(compGin$universe$levels["FxCb"])
# cost.list <- list(nodes = c("FxCb"),
#                         states = c("Cost-Based"))
# cost.find <- setEvidence(compGin, 
#                         nodes=cost.list$nodes,
#                         states=cost.list$states)
# fixed.list<-list(nodes = c("FxCb"),
#                         states = c("Fixed-Price"))
# fixed.find <- setEvidence(compGin, 
#                         nodes=fixed.list$nodes,
#                         states=fixed.list$states)
# 


QueryCrossSectionOnNode<-function(
                        gin,
                        PivotNode,
                        QueryNode
                        )
    {
    looper<-NULL
    for(x in unlist(gin$universe$levels[PivotNode])){
        looper<-rbind(looper,list(evidence=getEvidence(setEvidence(gin,
                                                                 nodes = c(PivotNode),
                                                                 states = c(x)
                                                     
                                                     )),
                                result=querygrain(setEvidence(gin,
                                                              nodes = c(PivotNode),
                                                              states = c(x))
                                                  , nodes = c(QueryNode)
                                                  )
                                )
              )
        }
    looper
    }
# 
# 
# querygrain(cost.find, nodes = c("Offr"))
# querygrain(fixed.find, nodes = c("Offr"),states=c("1"))
# 
# qCostCeil<-QueryCrossSectionOnNode(cost.find,"Ceil","Offr")
# qFixedCeil<-QueryCrossSectionOnNode(fixed.find,"Ceil","Offr")
# 
# # debug(QueryCrossSectionOnNode)
# qCostWhat<-QueryCrossSectionOnNode(cost.find,"What","Offr")
# qFixedWhat<-QueryCrossSectionOnNode(ContractModel,fixed.find,"What","Offr")
# row(qCostWhat)
# qCostWhat[6,]
# qFixedWhat[6,]
# 
# qCostPSR<-QueryCrossSectionOnNode(cost.find,"PSR","Offr")
# qFixedPSR<-QueryCrossSectionOnNode(fixed.find,"PSR","Offr")
# 
# qCostPSR[2,]
# qFixedPSR[2,]
# 
# for(x in 1:ncol(eCeil)){
#     
#     print(getEvidence(eCeil[,x]))
#     print(querygrain(eCeil[[,x]],nodes=c("Offr")))
#     }
# 
# 
# eCeil<-CompleteEvidenceLists(ContractModel,compGin,"Ceil",gin2.list)
# for(x in 1:ncol(eCeil)){
#     
#     print(getEvidence(eCeil[,x]))
#     print(querygrain(eCeil[[,x]],nodes=c("Offr")))
#     }
# 
# 
# test<-eCeil[,1]
# querygrain(test,nodes=c("Offr"))

# 
# CeilingFrames<-sapply(levels(ContractModel$Ceil),function(x) list(nodes = c(gin2.list$nodes,"Ceil"),
#                         states = c(gin2.list$states, x))
# 
#     
#     
#     data.frame(nodes = c("Comp","FxCb","Ceil"),
#                         states = c( "Comp.","Fixed-Price",x)))
# result<-list()
# for(x in 1:ncol(CeilingFrames )){
#     test <- setFinding(compGin, CeilingFrames[,x])
#     result<-rbind(result,list(CeilingFrames[,x],querygrain(test, nodes = c("Offr"))))
# }
# ncol(CeilingFrames )
# 
# test2<-setEvidence(compGin, CeilingFrames[,2])
# getEvidence(test2)
# # str(test2)
# 
# str(gin2.find)
# # str(eCeil[,1])
# 
# # as.dateCeil[,1]
# querygrain(gin2.find,nodes=c("Offr"))
# # querygrain(eCeil[,1],nodes=c("Offr"))
# # getEvidence(test2)


# 
# 
# ceiltest<-sapply(levels(ContractModel$Ceil),
#                  function(x)  setFinding(compGin, nodes = c("Comp","FxCb","Ceil"),
#                         states = c( "Comp.","Fixed-Price",x)))
# 
# sapply(unlist(ceiltest, function(x) querygrain(x, nodes = c("Offr")))

```

##H1: Large Research and Development (R&D) contracts will encounter challenges under fixed-price contracts. (On Contracting for Uncertain R&D) 

 *    Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	The first five phases of R&D as defined by product or service code will be included. This step excludes R&D management, support and operational system development. 
 *	The sample will include all contracts with a value of at least $25 million in either initial annualized base and all options amount of initial base and exercised options amount.

##Changes: 
The study team chose to use different contract size breakdowns than those used in past CSIS work (Contract_Ceiling). As a result, the closest available dividing point in the model is $30M. In this case, the $25M has no firmer theoretical basis and the $30M dividing line has the advantage of representing the weighted average contract ceiling. Thus the study team is updating the hypothesis to use the $30M standard instead.

For this example, we're still using usual R&D rather than excluding R&d7

##Results
The hypothesis is supported with regard to number of offers. Larger fixed-price contracts are more likely to experience single offer competition and are less likely to experience competition with three or more offers. Combination tracks more closely with fixed-price than cost-plus.

```{r H1LargeR&D}

ContractModel$Ceil

largeRnDfind<- setEvidence(compGin, 
                        nodes=c("PSR","Ceil"),
                        states=c("R&D","[30m+]")
)

getEvidence(largeRnDfind)

largeRnDcompFind<- setEvidence(largeRnDfind, 
                        nodes=c("Comp"),
                        states=c("Comp.")
)
getEvidence(largeRnDcompFind)

FxCBresult<-QueryCrossSectionOnNode(largeRnDcompFind,"FxCb","Offr")

#Combination
FxCBresult[1,1]
FxCBresult[1,2]
#Cost-plus
FxCBresult[2,1]
FxCBresult[2,2]
#Fixed-price
FxCBresult[3,1]
FxCBresult[3,2]


``` 

##H2: Due to design uncertainty Pre-Milestone B Major Defense Acquisition Programs (MDAPs) are potentially more likely to encounter problems than other fixed-price contracts
 *	Prerequisites for use of fixed-price: "Design content is established and the components are mature technologies. There are no signifi???cant unresolved design issues, no major integration risk, the external interfaces are well defined, and no serious risk exists of unknowns surfacing in developmental testing and causing major redesign." (Frank Kendall, Use of Fixed-Price Incentive Firm (FPIF) Contracts in Development and Production. Defense AT&L, (March-April 2013) pp 2-4.) {Emphasis added}
 *	Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	Using past CSIS research on Major Defense Acquisition Programs, CSIS will include in the sample System Equipment Codes for MDAPs that also include Pre-Milestone B spending. 
 *	Contracts will be included if greater than 50% of obligations are classified with a relevant System Equipment Code and/or if they are manually labeled as belonging to that MDAP.
 *	Note: This criteria will capture a similar sample to the prior R&D hypothesis. The study team would like to also include Major Automated Information Systems, but cannot because they are not labeled in FPDS.

#Temporary changes and next steps
MDAP specific classification is not yet included because it represents such a small portion of total contracts. It is presently planned to be incorporated through the Interlinked Variable. As an intermediate step.

#Initial results
The hypothesis was not supported with regard to number of offers, but this should be treated as a soft negative finding until the more precise question is tested.

```{r H2MDAP}

ContractModel$Link

HighLinkFind<- setEvidence(compGin, 
                        nodes=c("Link"),
                        states=c("[  750,67263]")
)

getEvidence(HighLinkFind)

HighLinkCompFind<- setEvidence(HighLinkFind, 
                        nodes=c("Comp"),
                        states=c("Comp.")
)
getEvidence(HighLinkCompFind)

FxCBresult<-QueryCrossSectionOnNode(HighLinkCompFind,"FxCb","Offr")

#Combination
FxCBresult[1,1]
FxCBresult[1,2]
#Cost-plus
FxCBresult[2,1]
FxCBresult[2,2]
#Fixed-price
FxCBresult[3,1]
FxCBresult[3,2]


``` 



##H3: Contracts with longer schedules will encounter greater problems with fixed-price contracts.
 *	"But price redetermination might be used whenever contingency charges otherwise would be included in a contract price due to such factors as prolonged delivery schedules, unstable market conditions for material or labor, or uncertainty as to cost of performance." (Fixed-prices and Price Redetermination in Defense Contracts)
 *	Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	Period of performance will be measured by expected contract duration in 4-week months (rounded up).

#Placeholder variable and next steps
This was initially expected to be tested with a continuous value for length rather than a discrete value. In addition the test would benefit from having more granularity at the high end of contract lengths. The next step will be to expand Dur's granularity in the greater than 1 year category.

#Initial results
The hypothesis regarding number of offers was not supported at the greater than 1 year level. Further subdivision into 2 year plus or other breakdowns might show a different result. Combination resembled fixed-price, but did not do as well with 5 or more offers.

```{r H3MDAP}
        
        levels(ContractModel$Dur)
        
        LongDurFind<- setEvidence(compGin, 
                                nodes=c("Dur"),
                                states=c("[  366,33192]")
        )
        
        getEvidence(LongDurFind)
        
        LongDurCompFind<- setEvidence(LongDurFind, 
                                nodes=c("Comp"),
                                states=c("Comp.")
        )
        getEvidence(LongDurCompFind)
        
        
        FxCBresult<-QueryCrossSectionOnNode(LongDurCompFind,"FxCb","Offr")
        
        #Combination
        FxCBresult[1,1]
        FxCBresult[1,2]
        #Cost-plus
        FxCBresult[2,1]
        FxCBresult[2,2]
        #Fixed-price
        FxCBresult[3,1]
        FxCBresult[3,2]


``` 



##H4: Fixed-price contracts with the potential competition for multiple offers will encounter fewer challenges.
 *	"[Principals] would prefer a fixed-price contract when the number of bidders increases." (On Contracting for Uncertain R&D)
 *	Complicating this relationship, are recent revisions to the DFAR that reduced the emphasis on seeking additional offers as long as a fair competitive price can be verified. (DFAR 215.371)
 *	Dependent Variables:
 *	Contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	Due to limitations in available data, CSIS will use whether or not a contract is initially competed as a broad proxy for whether competition with multiple offers is available. CSIS will follow standard DoD procedures in identifying competed contracts.
 *	Note: Testing for this hypothesis is constrained by a lack of relevant data in  FPDS. The number of offers requested field was dispensed with when the DoD contract system was folded into FPDS. (See "Hypotheses which raise causality concerns" (slide 21-22) for further discussion.) 

#Next steps.

This hypothesis is requires incorporation of the next two dependent variables into the Bayesian Network.



##H5: Fixed-price are preferred by vendors for larger software contracts
 *	"We hypothesize that the vendor's ability to leverage information asymmetry about capabilities and experiences translates into the vendor preferring Fixed-Price contract to secure larger information rents. Our results support this hypothesis and suggest that the vendor would prefer the FP contract for larger and longer projects with larger teams. However, vendors would prefer a [Time and Materials] contract when the risk of employee attrition from the project team is high." (Research Note: On Vendor Preferences for Contract Types in Offshore Software Projects: The Case of fixed-price vs. Time and Materials Contracts)
 *	Dependent Variables:
 *	Single offer competition and contract termination. 
 *	Initial Taxonomy:
 *	Past CSIS research has found that software contracts are not all contained within the Automated Data Processing category of the product or service codes. CSIS tentatively plans to include contracts with greater than 50% by value content in the Information and Communication Technology services category
 *	Note: This hypothesis tests commercial vendor practices, but contradicts other government-focused observations. This is because this study does not seek to construct only consistent hypotheses, but instead to test a range of ideas from the literature.
Hypotheses regarding general contract performance that may be used as controls
Contracts for aircraft have more challenges than other contracts

#Placeholder and next steps
Software is typically classified as a service under PSR, though also could be under R&D, and is especially prominent in electronics in communication under What. Given that all sorts of platforms have software, PSR would be the best place to incorporate it under the present model, possibly linking software services and software R&D. NAICS codes may also assist. Software is not particularly easy to identify in FPDS as it is often incorporated into larger contracts, but there should be a number of clearcut cases.

#Initial results

Electronics and communications services do have a slight preference for fixed-price contracts when it comes to number of offers. However, when R&D is also included, the advantage switches to Cost-based.

```{r H5Software}

summary(levels(ContractModel$PSR))
    
    SoftwareFind<- setEvidence(compGin, 
                            nodes=c("What","PSR"),
                            states=c("Electronics and Communications","Services"))
    
    
    getEvidence(SoftwareFind)
    
    SoftwareCompFind<- setEvidence(SoftwareFind, 
                            nodes=c("Comp"),
                            states=c("Comp.")
    )
    getEvidence(SoftwareCompFind)
    
    
            FxCBresult<-QueryCrossSectionOnNode(SoftwareCompFind,"FxCb","Offr")
            
            #Combination
            FxCBresult[1,1]
            FxCBresult[1,2]
            #Cost-plus
            FxCBresult[2,1]
            FxCBresult[2,2]
            #Fixed-price
            FxCBresult[3,1]
            FxCBresult[3,2]

SoftwareFind<- setEvidence(compGin, 
                        nodes=c("What","PSR"),
                        states=c("Electronics and Communications",list(c("Services","R&D")))
)
getEvidence(SoftwareFind)

SoftwareCompFind<- setEvidence(SoftwareFind, 
                        nodes=c("Comp"),
                        states=c("Comp.")
)

FxCBresult<-QueryCrossSectionOnNode(SoftwareCompFind,"FxCb","Offr")
        
        #Combination
        FxCBresult[1,1]
        FxCBresult[1,2]
        #Cost-plus
        FxCBresult[2,1]
        FxCBresult[2,2]
        #Fixed-price
        FxCBresult[3,1]
        FxCBresult[3,2]

``` 




 *	Aircraft have a 22 point corresponding effect on total contract growth that is explained by schedule and cost overruns. The report looked at time, schedule, and differences between major commands, but not contract pricing mechanism. (Performance of the Defense Acquisition System 2013)
 *	"During the Second World War leading belligerents such as Britain, the United States, and Germany, favored the use of fixed-price contracts for purchasing military aircraft. These contracts were believed to encourage economical and efficient production. Yet only Britain succeeded in developing contractual procedures based primarily upon the fixed-price. This was primarily driven by the degree of organization by the weapons companies." (The Price of Air Power: Technological Change, Industrial Policy, and Military Aircraft Contracts in the Era of British Rearmament, 1935-39)
 *	Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	The sample will include all contracts with a 50 percent or greater share of obligations in the Aircraft and Drone platform portfolio.

#Changes
The model incorporated a 75% threshold for classification as a given Platform under What. This excludes some contracts, but captured the vast majority of contracts with a mix of platforms.

#Results
As expected, numbers of offers are far higher with non-aircraft, for both competed and for all contracts.

```{r HC1Aircraft}

levels(ContractModel$What)

AircraftFind<- setEvidence(compGin, 
                        nodes=c("What"),
                        states=c("Aircraft and Drones")
)

AircraftCompFind<- setEvidence(AircraftFind, 
                        nodes=c("Comp"),
                        states=c("Comp.")
)


getEvidence(AircraftFind)
querygrain(AircraftFind,"Offr")

getEvidence(AircraftCompFind)
querygrain(AircraftCompFind,"Offr")


NotAircraftFind<- setEvidence(compGin, 
                        nodes=c("What"),
                        states=c(list(
                            levels(ContractModel$What)[levels(ContractModel$What)!=
                                                           "Aircraft and Drones"]))
                        )

getEvidence(NotAircraftFind)
querygrain(NotAircraftFind,"Offr")


NotAircraftCompFind<- setEvidence(NotAircraftFind, 
                        nodes=c("Comp"),
                        states=c("Comp.")
)


getEvidence(NotAircraftCompFind)
querygrain(NotAircraftCompFind,"Offr")

``` 


##C2: Undefinitized contract actions (UCAs) in development will encounter more problems
 *	"For example, analysis is revealing that UCAs can be successfully employed in early production but are concerns for developmental work" (Performance of the Defense Acquisition System 2013)
 *	"UCAs increase development cycle time by increasing schedule growth." GAO Study
 *	"The contractor has little incentive to control costs during this period.". (GAO study?)
 *	DOD has had difficulty overseeing the use of UCAs on at least three levels: (1) how and when to use UCAs, (2) definitizing UCAs in a timely fashion and 3) documenting the basis for negotiated profit or fees (GAO study?)
 *	Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	UCA status will be defined as those contracts labeled as "Letter Contracts."
 *	The first five phases of R&D as defined by product or service code will be included. This excluding R&D management and support and operational system development. 
 *	Contracts will be included in the sample if more than 50 percent of obligations in any given year meet the above criteria.

###Next steps: 
UCA status will be added to IDV. Since the contract type will not be known at the offset, the information lost will primarily be information not available to the contracting officer at contract start. However, theres no available proxy until that information is added.

##Contracts that are initially expected to be very large contracts will encounter more problems.
 *	For overall DoD contracting in 2013, contracts with an annual value of $500 or more saw the lowest rate of competition with three or more offers- 20 percent. The next lowest rate for contracts between $100 million and $500 million (26 percent). (CSIS Analysis of FPDS Data).
 *	Dependent Variables:
 *	Single offer competition, contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	The sample will include all contracts with an initial annualized base and all options amount of at least $500 million, or a initial base and exercised options amount of at least $500 million.

###Placeholder and next steps.
$500M contracts is not a level of granularity yet available in the Ceil variable, so the lower $30M threshold will be used for the initial analysis. In addition, the criteria we are using is base and all values alone, but that should always match or exceed the base and exercised value. 


##Contracts initially expected to have smaller values will receive more offers.
 *	For overall DoD contracting in 2013, contracts with an annual value of less than $250,000 saw the highest rate of competition with two or more offers (62 percent), and that rate generally declines as size of contract increases. (CSIS Analysis of FPDS Data)
 *	Dependent Variables:
 *	Single offer competition.
 *	Initial Taxonomy:
 *	The independent variable will be the base and all exercised options amount for the contract. This value will not be annualized, as the steady rate of exercising options means that the initial value has severe limitations when predicting total contract value.



##Contracts using purchase orders and "Other Indefinite Delivery Contracts (IDCs)" are more likely to receive a single offer.
 *	Past CSIS research has found that contracts using a purchase orders and "Other IDCs" (Other IDCs includes Federal Supply Schedule, Basic Ordering Agreements, Blanket Purchasing Agreements, Government-Wide Acquisition Contracts) have notably higher  rates of single offer competition than other vehicles. (CSIS, Federal Services Contracting and the Supporting Industrial Base, 2000-2012)
 *	Dependent Variables:
 *	Single offer competition.
 *	Initial Taxonomy:
 *	The sample will include contracts with a 50 percent or greater share of obligations reporting purchase orders or "Other IDCs".

##Contracts with longer initially expected periods of performance will encounter more problems.
 *	Past CSIS research on cost overruns in major defense acquisition projects have found that cost growth is correlated with contract duration. "If cost increases accrue over time, then programs with an older baseline estimate would tend to accumulate relatively higher cost increases. The data for the analyzed programs show that older programs indeed experience larger overruns... this growth correlation not only provides further evidence for the assertion that cost growth occurs steadily throughout the program lifespan, but it also suggests that younger programs are not performing better than older programs." (David Berteau et al.: Cost and Time Overruns for Major Defense Acquisition Programs (2011))
 *	Dependent Variables:
 *	Contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	Period of performance will be measured as expected contract duration in 4-week months, rounding up.
 *	Note: CSIS is including a separate hypothesis (Slide 9) to test whether fixed-price contracts encounter an even greater number of problems under contracts with longer expected periods of performance 

##Incentive Fee contracts experience fewer problems than other forms of contracts.
 *	"Incentive formula-type contracts had lower cost growth at the median (i.e., its central tendency), shared savings with the government, and earned slightly lower margins than CPAF/CPFF/CS/other (O) contracts. In other words, to achieve about the same margin on incentive formula-type contracts, contractors had to control cost growth better-and they did so." (Performance of the Defense Acquisition System, 2014) This finding is in line with multiple earlier policy statements from Undersecretary Kendall emphasizing fixed-price incentive fee contracts and vendor motivation. 
 *	One study uses the F-35 as a case study to examine when to utilize different types of contract incentive structures. The model presented in this study could provide insight into the use of different types of fixed-price contracts. (The Effect of Processes and Incentives on Acquisition Cost Growth)
 *	Dependent Variables:
 *	Contract termination, number of change orders, and cost of change orders.
 *	Initial Taxonomy:
 *	The sample will include contracts with a 50 percent or greater share of obligations reporting cost-plus incentive fee or fixed-price incentive fee as the pricing mechanism.

Hypotheses considered for inclusion in later stages of the project if necessary

 *	DAU guidance suggests different forms of fixed-price contracts depending on the stage of development. This goes beyond the advantages of incentive contracts to suggest that certain types of fee structures work better for different phases of a project. However, phases are not clearly labeled in FPDS, complicating any attempt to test this hypothesis.

#Hypotheses not being tested at this time.
###Does workload factor into a contracting officer's decision whether or not to use fixed-price contract? The dearth of useful and readily available data may limit CSIS's ability to test this hypothesis. 
 *	One study analyzes contracting officer workload data, noting a decrease in the use of fixed-price contract types when contractor workload increases. Were this data widely available, it would assist in explaining differences in practice between contracting offices. (Unintended Consequences of Advocating Use of Fixed-Price Contracts in Defense Acquisition Practice)

###In addition, the broader budget environment may influence the rate of adoption usage of fixed-price contracts
 *	For risk averse sellers, an adjustable price (spot) price contract is advantageous when the cost of production is uncertain. However, if the level of demand is uncertain, risk averse buyers would find fixed-price contracts to be superior. (Fixed-price versus Spot Price Contracts: A Study in Risk Allocation) In the latter case, vendors could not count on making profits in production and may instead rely on a greater risk premium within a fixed-price contract.

##Hypotheses which raise causality concerns
These involve independent variables that are not necessarily known before the contracting officer specifies a contract as fixed-price. These variables are available, but raise severe causality concerns because their existence may not have been known at the time the contract was initially created. As a result, they will not be included unless these concerns can be resolved.
 *	Contracts with a greater expected number of offers will encounter fewer problems with fixed-price contracts. 
 *	"[Price and schedule growth were lower on competed and sole-source modification contracts than on sole-source [(i.e. including uncompleted and single-offer competition)] contracts for new systems. These analyses demonstrate the general benefit of competition on cost, price, and schedule control. Like price growth, cost growth (not shown) for competed and sole-source modification contracts was lower than that for sole-source contracts for new systems."(Performance of the Defense Acquisition System, 2014)
 *	[Principals] would prefer a fixed-price contract when the number of bidders increases. (On Contracting for Uncertain R&D)

 *	Contracts expected to be won by the Big-6 Defense firms will encounter fewer problems with fixed-price contracts.
 *	Qualified suppliers: Bidders will be firms that have experience with this kind of product and can be expected to bid rationally and perform to plan (Frank Kendall, Use of Fixed-Price Incentive Firm (FPIF) Contracts in Development and Production. Defense AT&L, (March-April 2013) pp 2-4.) 
Contracts expected to be won by the Big-6 Defense firms are less likely to use fixed-price contracts.
 *	"In the offshore drilling industry, we find that oil and gas companies are less likely to choose fixed-price contracts as the frequency of their interaction with a driller increases. This supports the conclusion that repeated interaction and high-powered formal contracts are substitutes in this setting, indicating that repeated interaction reduces incentive problems more than contracting costs." (The Effect of Repeated Interaction on Contract Choice: Evidence from Offshore Drilling) 
Larger vendors will fare better with larger contracts.
 *	"Sometimes overruns will happen despite everyone's best efforts. We still want responsible contractors who have the capacity to continue and deliver the product despite potential overruns that may not have been foreseeable". ( Frank Kendall, Use of Fixed-Price Incentive Firm (FPIF) Contracts in Development and Production. Defense AT&L, (March-April 2013) pp 2-4.)

##Hypotheses that cannot be measured with CSIS's existing databases 
CSIS does not have an analytical framework for including these hypotheses. They are included in this briefing to ensure comprehensiveness and to offer an opportunity for outside reviewers to suggest new ideas for analytical frameworks.
 * Firm requirements: "Cost vs. performance trades are essentially complete. In essence, we have a very clear under???standing of what we want the contractor to build, and we are confident that the conditions exist to permit the design of an affordable product that the user will be able to afford and is committed to acquiring". (Frank Kendall, Use of Fixed-Price Incentive Firm (FPIF) Contracts in Development and Production. Defense AT&L, (March-April 2013) pp 2-4.)
 * Expert Knowledge: One pillar of Secretary Kendall's "firm requirements" is the requirement that contracting officers be equipped with 'a clear understanding' of all sides of the trade. Currently, there is no mechanism in FPDS that captures as a value "expert knowledge of the marketplace".  
 * 	Low technical risk: "Design content is established and the components are mature technologies. There are no significant unresolved design issues, no major integration risk, the external interfaces are well defined, and no serious risk exists of unknowns surfacing in developmental testing and causing major redesign". (Frank Kendall, Use of Fixed-Price Incentive Firm (FPIF) Contracts in Development and Production. Defense AT&L, (March-April 2013) pp 2-4.)

Several hypotheses relate to market conditions and cost uncertainty:
 *	"However, vendors would prefer a [Time and Materials] contract when the risk of employee attrition from the project team is high." (Research Note: On Vendor Preferences for Contract Types in Offshore Software Projects: The Case of fixed-price vs. Time and Materials Contracts)
 *	But price redetermination might be used "whenever contingency charges otherwise would be included in a contract price due to such factors as pro-longed delivery schedules, unstable market conditions for material or labor, or uncertainty as to cost of performance (emphasis added)." (Fixed-prices and Price Redetermination in Defense Contracts)
 *	The issue of complexity has come up in different studies. Generally these studies find that complexity is associated with worse performance, but it is difficult to measure the complexity of projects at the contract level.  MDAP and R&D factors, which are already included in this project, are suggested as offering the most straightforward values that reflect project complexity .
 *	Cost-plus contracts are preferred to fixed-price contracts when a project is more complex. (Incentives versus Transaction Costs: A Theory of Procurement Contracts)

 *	Renegotiations and other attempts to regulate extraordinary profits are likewise difficult to measure for the system writ-large.
 *	This article examines the determinants of contractual form and renegotiations in the German construction industry during the Third Reich. At the beginning of World War II, firms dealt with growing uncertainty by convincing procurement agencies either to use cost-plus contracts or to include an additional risk premium in fixed-price contracts. In the later years of the war, procurement agencies initiated renegotiations over contract clauses to reduce the extraordinary profits resulting from information rents and high-risk premiums. This regulatory course undermined the credibility of the regulatory commitment, thereby weakening the incentives of the fixed-price contracts still in use. (Negotiating Contract Types and Contract Clauses in the German Construction Industry during the Third Reich)

