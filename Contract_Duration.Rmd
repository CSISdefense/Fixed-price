---
title: 'DoD Fixed-Price Study: Contract Duration Classification'
author: "Greg Sanders"
date: "Tuesday, January 13, 2015"
output:
  html_document:
    keep_md: yes
    toc: yes
---

```{r hiddensetup, echo = FALSE}
require(ggplot2)
require(stringr)
require(plyr)
require(Hmisc)
require(lubridate)
options(error=recover)
setwd("K:\\Development\\Fixed-price")
# setwd("C:\\Users\\Greg Sanders\\Documents\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"
source(paste(Path,"lookups.r",sep=""))

```

Contracts are classified using a mix of numerical and categorical variables. While the changes in numerical variables are easy to grasp and summarize, a contract may have one line item that is competed and another that is not. As is detailed in the [exploration on R&D](RnD_1to5_exploration.md), we are only considering information available prior to contract start. The percentage of contract obligations that were competed is a valuable benchmark, but is highly influenced by factors that occured after contract start..

##Studying contract duration within the sample.
Initial contract duration is a new characteristic for CSIS.  The duration is calculated by comparing the earliest *effective date* to *current completion date.*  The current date was used rather than the *ultimate complete date* because the later is often unlabeled.  

##Methodological Notes on Contract Period of Performance

*Signed date* of the unmodified contract is used as a criteria for inclusion because the fiscal year used for reporting, and thus presumably certification, is based on *signed date* and not *effective date*.  CSIS may refine this methodology based on consultation with experts and further study of that data.  For greater transparency, considered alternatives have been listed with each period of performance value below: 

**The contract start date** is the earliest *effective date* reported under the contract.
* Alternatives include using *signed date* or using the unmodified contract values rather than the earliest values throughout the contract.

**The contract end date** is the *current completion date* of the most recently signed contract modification.
* *Ultimate completion date* is one alternative and is based on the theoretical maximum period of performance if all options were exercised.
* *Last date to order* is only available for indefinite delivery vehicles and refers to the start and not the end date of a delivery order, but it is another possible alternative.
* Finally, the modification with the most recent *signed date* could be replaced by the modification with the most recent *effect date* or instead the dates furthest in the future could be chosen.  

**Completed contracts** have a contract end date in FY2013 or have been marked as closed and/or terminated. 

```{r setup, echo = TRUE}
ContractSample  <- read.csv(
    paste("data\\defense_contract_CSIScontractID_sample_100000_SumofObligatedAmount.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )

#These will probably be moved into apply_lookups at some point
ContractSample<-apply_lookups(Path,ContractSample)

summary(subset(ContractSample,
               select=c(LastSignedLastDateToOrder,
      LastUltimateCompletionDate,
      LastCurrentCompletionDate,
      UnmodifiedCurrentCompletionDate,
      UnmodifiedUltimateCompletionDate,
      UnmodifiedLastDateToOrder,
      MinOfEffectiveDate,
      MinOfSignedDate
      
                                ))
        )



as.numeric(as.duration(
    ymd(Policy$SignedMonth)-Policy$StartFiscalYear)
    /dyears(1)
    )



min(strptime(ContractSample$MinOfEffectiveDate[!is.na(ContractSample$MinOfEffectiveDate)],"%Y-%m-%d"))
max(strptime(ContractSample$UnmodifiedCurrentCompletionDate[!is.na(ContractSample$UnmodifiedCurrentCompletionDate)],"%Y-%m-%d"))


ContractSample$UnmodifiedDays<-as.numeric(difftime(strptime(ContractSample$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
                                                     , strptime(ContractSample$MinOfEffectiveDate,"%Y-%m-%d")
                                                     , unit="days"
        ))+1


daysquantile<-quantile(ContractSample$UnmodifiedDays,c(0.25,0.5,0.75),na.rm=TRUE)
exp(quantile(log(ContractSample$UnmodifiedDays),c(0.25,0.5,0.75),na.rm=TRUE))
mean(ContractSample$UnmodifiedDays,na.rm=TRUE)
exp(mean(log(ContractSample$UnmodifiedDays),na.rm=TRUE))
ecdf(ContractSample$UnmodifiedDays)(214)

roundedcutoffs<-c(61,214,364,365,366,367,368,729,730,731,732,733,734)
ecdf(ContractSample$UnmodifiedDays)(roundedcutoffs)


ContractComplete  <- read.csv(
    paste(Path,"data\\defense_contract_SP_ContractSampleCriteriaDetailsCustomer.csv", sep = ""),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
    )
# ContractComplete$LastCurrentCompletionDate<-strptime(ContractComplete$LastCurrentCompletionDate,"%Y-%m-%d") 
# # as.Date(sample.criteria$LastCurrentCompletionDate)
# ContractComplete<-subset(ContractComplete,StartFiscal_Year>=2007 & (LastCurrentCompletionDate<=strptime("2013-09-30","%Y-%m-%d") | IsClosed==1))
# 
# ContractComplete$UnmodifiedDays<-as.numeric(difftime(strptime(ContractComplete$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
#                                                      , strptime(ContractComplete$MinOfEffectiveDate,"%Y-%m-%d")
#                                                      , unit="days"
#         ))+1
dayscompletequantile<-quantile(ContractSample$UnmodifiedDays,c(0.25,0.5,0.75,0.95),na.rm=TRUE)



span <- new_interval(as.POSIXct(ContractSample$UnmodifiedCurrentCompletionDate), 
                     as.POSIXct(ContractSample$MinOfEffectiveDate)) #interval

eyears(as.period(span))
as.period(span, units ="years")
# 2009-01-01 CST--2010-02-02 01:01:01 CST
as.period(span)


dSeconds<-as.duration(strptime(ContractSample$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
                strptime(ContractSample$MinOfEffectiveDate,"%Y-%m-%d"))

summary(dSeconds%/%dyears(1))
summary(dSeconds/years(1))


ggplot(
    data = ContractSample,
    aes_string(x = "UnmodifiedDays",
               fill = "qDuration")
    ) +     geom_bar(binwidth=7)  +scale_x_continuous(limits=c(0, 2000))


ggplot(
    data = ContractSample,
    aes_string(x = "log(UnmodifiedDays)",
                fill = "qDuration")
    ) +     geom_bar(binwidth=0.1)  #+scale_x_continuous(limits=c(0, 2000))





```


