---
title: "Defense Contract Statistics Model Complete"
author: "Greg Sanders"
date: "Monday, March 23, 2015"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#*************************************Required Libraries******************************************
require(plyr)
require(grid)
require(reshape2)
require(stringr)
require(ggplot2)
require(Hmisc)
#*************************************Options*****************************************************
options(error=recover)
options(warn=1)

#*************************************Lookup Files*****************************************************
setwd("K:\\Development\\Fixed-price")
Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
set.seed(1)
# Path<-"~\\FPDS\\R scripts and data\\"
# Path<-"C:\\Users\\Greg Sanders\\SkyDrive\\Documents\\R Scripts and Data SkyDrive\\"

source(paste(Path,"helper.r",sep=""))
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))

```


```{r DetailCustomer}
# defense_contract_SP_ContractSampleCriteriaDetailsCustomer
CompleteContracts <-read.csv(
    paste(Path,"data\\defense_contract_SP_ContractSampleCriteriaDetailsCustomer.csv",sep=""),
    header=TRUE, sep=",", dec=".", strip.white=TRUE, 
    na.strings=c("NULL","NA"),
    stringsAsFactors=FALSE
    )


#Limit to completed contracts that start in 2007 or later
CompleteContracts$LastCurrentCompletionDate<-strptime(CompleteContracts$LastCurrentCompletionDate,"%Y-%m-%d") 
#Drop contracts starting before the study period
CompleteContracts<-subset(CompleteContracts,
                          StartFiscal_Year>=2007 & 
                              (LastCurrentCompletionDate<=strptime("2013-09-30","%Y-%m-%d") | IsClosed==1))


CompleteContracts<-subset(CompleteContracts,select=-c(StartFiscal_Year
                                                      ,IsClosed
                                                      ,LastSignedLastDateToOrder
#                                                       ,LastUltimateCompletionDate
                                                      ))

```



```{r ContractDiscretization}

#data\\defense_contract_contractdiscretization.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_contractdiscretization.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )

CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts<-subset(CompleteContracts,select=-c(
    SumOfnumberOfActions,
#     Action.Obligation,
    StartFiscal_Year,
    maxoffiscal_year
#     MinOfSignedDate,
#     ,LastCurrentCompletionDate
    ))

```


```{r Interlinked}

#data\\defense_contract_SP_ContractInterlinkedUnmodifiedSystemEquipmentPlatform.csv
CompleteContracts<-read_and_join(Path,
                                 "defense_contract_SP_ContractInterlinkedUnmodifiedSystemEquipmentPlatform.csv",
                                 CompleteContracts,
                                 "data\\",
                                 by="CSIScontractID"
                                 )

#data\\Office_processedCSIScontractIDtoContractingOfficeID_linked.csv
CompleteContracts<-read_and_join(Path,
                                 "Office_processedCSIScontractIDtoContractingOfficeID_linked.csv",
                                 CompleteContracts,
                                 "data\\",
                                 by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

#Add up interlinked values
CompleteContracts$ContractingOfficePlatformInterlinked[is.na(CompleteContracts$ContractingOfficePlatformInterlinked)]<-0
CompleteContracts$SystemEquipmentInterlinked[is.na(CompleteContracts$SystemEquipmentInterlinked)]<-0
CompleteContracts$LinkedContracts<-CompleteContracts$ContractingOfficePlatformInterlinked+CompleteContracts$SystemEquipmentInterlinked

#Break the interlinked into three categories
CompleteContracts$qLinked <- cut2(CompleteContracts$LinkedContracts,cuts=c(1,750))

#Drop the no longer needed variables
# CompleteContracts<-subset(CompleteContracts,select=-c(
#     SystemEquipmentInterlinked,
#     ContractingOfficePlatformInterlinked,
#     LinkedContracts,
#     unmodifiedSystemequipmentcode
#     ))

summary(CompleteContracts$unmodifiedSystemequipmentcode)

```

```{r ContractingDelta}

#defense_contract_SP_ContractModificationDeltaCustomer.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractModificationDeltaCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts$ChangeOrderObligatedAmount<-FactorToNumber(CompleteContracts$ChangeOrderObligatedAmount)
CompleteContracts$ChangeOrderBaseAndAllOptionsValue<-FactorToNumber(CompleteContracts$ChangeOrderBaseAndAllOptionsValue)


# CompleteContracts<-subset(CompleteContracts,select=-c(
#     ChangeOrderObligatedAmount             ,
#     ChangeOrderBaseAndExercisedOptionsValue,
#     ChangeOrderBaseAndAllOptionsValue      ,
#     NewWorkObligatedAmount,
#     NewWorkBaseAndExercisedOptionsValue    ,
#     NewWorkBaseAndAllOptionsValue,
#     ChangeOrderObligatedAmount             ,
#     ChangeOrderBaseAndExercisedOptionsValue,
#     ChangeOrderBaseAndAllOptionsValue      ,
#     NewWorkObligatedAmount,
#     NewWorkBaseAndExercisedOptionsValue    ,
#     NewWorkBaseAndAllOptionsValue          
#     ))
```

```{r Location}

#defense_contract_SP_ContractLocationCustomer.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractLocationCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts$ObligatedAmountIsInternational<-FactorToNumber(CompleteContracts$ObligatedAmountIsInternational)

CompleteContracts$pIsInternational<-CompleteContracts$ObligatedAmountIsInternational/
    CompleteContracts$Action.Obligation
CompleteContracts$pIsInternational[is.na(CompleteContracts$ObligatedAmountIsInternational)] <- 0

if(is.numeric(CompleteContracts$AnyInternational)){
    CompleteContracts$AnyInternational<-factor(CompleteContracts$AnyInternational,
                                               exclude=NULL,
                                               levels=c(0,1,NA),
                                               labels=c("Just U.S.","Any International","Unlabeled")
                                               )
    }
CompleteContracts$AnyInternational[CompleteContracts$pIsInternational<=0 & 
                                       CompleteContracts$AnyInternational=="Any International" &
                                       CompleteContracts$UnmodifiedIsInternational==0]<-"Just U.S."


CompleteContracts<-subset(CompleteContracts,select=-c(
    UnmodifiedIsInternational,
    IsInternational,
    ObligatedAmountIsInternational,
    UnmodifiedPlaceCountryISO3,
    PlaceCountryISO3,
    X
    ))

```


```{r Outcome}
#"data\\Defense_contract_SP_ContractUnmodifiedandOutcomeDetailsCustomer.csv"

CompleteContracts<-read_and_join(Path
                                 ,"Defense_contract_SP_ContractUnmodifiedandOutcomeDetailsCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts$UnmodifiedCurrentCompletionDate<-
    strptime(CompleteContracts$UnmodifiedCurrentCompletionDate,"%Y-%m-%d") 

#Calculate the number of days the contract lasts.
CompleteContracts$UnmodifiedDays<-as.numeric(
    difftime(strptime(CompleteContracts$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")
             , strptime(CompleteContracts$MinOfEffectiveDate,"%Y-%m-%d")
             , unit="days"
             ))+1


CDuration<-as.duration(strptime(CompleteContracts$UnmodifiedCurrentCompletionDate,"%Y-%m-%d")-
                strptime(CompleteContracts$MinOfEffectiveDate,"%Y-%m-%d"))

CPeriod<-as.period(
    CInterval<-new_interval(ymd(CompleteContracts$UnmodifiedCurrentCompletionDate),
                ymd(CompleteContracts$MinOfEffectiveDate))

%/%dyears(1)

summary(dYears)

#Break the count of days into four categories.
CompleteContracts$qDuration<-cut2(CompleteContracts$UnmodifiedDays,cuts=c(61,214,366,732))
#(15000,100000,1000000,30000000)
roundedcutoffs<-c(15000,100000,1000000,10000000,75000000)
CompleteContracts$qCeiling <- cut2(CompleteContracts$UnmodifiedContractBaseAndAllOptionsValue,cuts=roundedcutoffs)
rm(roundedcutoffs)

CompleteContracts$qLinked <- cut2(CompleteContracts$LinkedContracts,cuts=c(1,750))

CompleteContracts$qNChg <- cut2(CompleteContracts$SumOfisChangeOrder,c(1,2,3))

CompleteContracts$pChangeOrderObligated<-CompleteContracts$ChangeOrderObligatedAmount/CompleteContracts$Action.Obligation

CompleteContracts$qCRais <- cut2(
    CompleteContracts$pChangeOrderObligated,c(
                                              -0.001,
                                              0.001,
                                              0.12)
    )
#                                               min(subset(
#                                                   CompleteContracts$pChangeOrderObligated,
#                                                   CompleteContracts$pChangeOrderObligated>0)),

summary(subset(CompleteContracts$qCRais,CompleteContracts$SumOfisChangeOrder>0    ))

CompleteContracts<-subset(CompleteContracts,select=-c(
#     UnmodifiedDays,
#     UnmodifiedCurrentCompletionDate
#     MinOfEffectiveDate,
    MinOfSignedDate,
    LastUltimateCompletionDate
    ))


```

```{r BucketPlatform}
#data\\defense_contract_SP_ContractBucketPlatformCustomer.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractBucketPlatformCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts$ObligatedAmountIsProducts<-FactorToNumber(CompleteContracts$ObligatedAmountIsProducts)

CompleteContracts$ObligatedAmountIsServices<-FactorToNumber(CompleteContracts$ObligatedAmountIsServices)

CompleteContracts$ObligatedAmountIsRnD<-FactorToNumber(CompleteContracts$ObligatedAmountIsRnD)

CompleteContracts$pIsProducts <- CompleteContracts$ObligatedAmountIsProducts/CompleteContracts$Action.Obligation
CompleteContracts$pIsProducts[is.na(CompleteContracts$ObligatedAmountIsProducts)] <- 0

CompleteContracts$pIsServices <- CompleteContracts$ObligatedAmountIsServices/CompleteContracts$Action.Obligation
CompleteContracts$pIsServices[is.na(CompleteContracts$ObligatedAmountIsServices)] <- 0

CompleteContracts$pIsRnD <- CompleteContracts$ObligatedAmountIsRnD/CompleteContracts$Action.Obligation
CompleteContracts$pIsRnD[is.na(CompleteContracts$ObligatedAmountIsRnD)] <- 0


CompleteContracts$ObligatedAmountIsLand<-FactorToNumber(CompleteContracts$ObligatedAmountIsLand)
    
CompleteContracts$ObligatedAmountIsVessel<-FactorToNumber(CompleteContracts$ObligatedAmountIsVessel)
    

CompleteContracts$ObligatedAmountIsVessel<-FactorToNumber(CompleteContracts$ObligatedAmountIsAir)

CompleteContracts$ObligatedAmountIsVessel<-FactorToNumber(CompleteContracts$ObligatedAmountIsOtherPP)

CompleteContracts$ObligatedAmountIsWnA<-FactorToNumber(CompleteContracts$ObligatedAmountIsWnA)

CompleteContracts$ObligatedAmountIsMnS<-FactorToNumber(CompleteContracts$ObligatedAmountIsMnS)

CompleteContracts$ObligatedAmountIsEnC<-FactorToNumber(CompleteContracts$ObligatedAmountIsEnC)

CompleteContracts$ObligatedAmountIsFRSnC<-FactorToNumber(CompleteContracts$ObligatedAmountIsFRSnC)
    

CompleteContracts$pIsLand <- CompleteContracts$ObligatedAmountIsLand/CompleteContracts$Action.Obligation
CompleteContracts$pIsLand[is.nan(CompleteContracts$pIsLand)|is.infinite(CompleteContracts$pIsLand)|is.na(CompleteContracts$ObligatedAmountIsLand)] <- 0

CompleteContracts$pIsVessel <- CompleteContracts$ObligatedAmountIsVessel/CompleteContracts$Action.Obligation
CompleteContracts$pIsVessel[is.nan(CompleteContracts$pIsVessel)|is.infinite(CompleteContracts$pIsVessel)|is.na(CompleteContracts$ObligatedAmountIsVessel)] <- 0

CompleteContracts$pIsOtherPP <- CompleteContracts$ObligatedAmountIsOtherPP/CompleteContracts$Action.Obligation
CompleteContracts$pIsOtherPP[is.nan(CompleteContracts$pIsOtherPP)|is.infinite(CompleteContracts$pIsOtherPP)|is.na(CompleteContracts$ObligatedAmountIsOtherPP)] <- 0

CompleteContracts$pIsAir <- CompleteContracts$ObligatedAmountIsAir/CompleteContracts$Action.Obligation
CompleteContracts$pIsAir[is.nan(CompleteContracts$pIsAir)|is.infinite(CompleteContracts$pIsAir)|is.na(CompleteContracts$ObligatedAmountIsAir)] <- 0

CompleteContracts$pIsEnC <- CompleteContracts$ObligatedAmountIsEnC/CompleteContracts$Action.Obligation
CompleteContracts$pIsEnC[is.nan(CompleteContracts$pIsEnC)|is.infinite(CompleteContracts$pIsEnC)|is.na(CompleteContracts$ObligatedAmountIsEnC)] <- 0

CompleteContracts$pIsFRSnC <- CompleteContracts$ObligatedAmountIsFRSnC/CompleteContracts$Action.Obligation
CompleteContracts$pIsFRSnC[is.nan(CompleteContracts$pIsFRSnC)|is.infinite(CompleteContracts$pIsFRSnC)|is.na(CompleteContracts$ObligatedAmountIsFRSnC)] <- 0


CompleteContracts$pIsMnS <- CompleteContracts$ObligatedAmountIsMnS/CompleteContracts$Action.Obligation
CompleteContracts$pIsMnS[is.nan(CompleteContracts$pIsMnS)|is.infinite(CompleteContracts$pIsMnS)|is.na(CompleteContracts$ObligatedAmountIsMnS)] <- 0


# TempList<-c("PlatformPortfolio","UnmodifiedPlatformPortfolio","ObligatedAmountIsAir","ObligatedAmountIsEnC","ObligatedAmountIsFRSnC","ObligatedAmountIsLand","ObligatedAmountIsMnS","ObligatedAmountIsOtherPP","ObligatedAmountIsVessel","ObligatedAmountIsWnA","ProductOrServiceArea","UnmodifiedProductOrServiceArea","SimpleArea","UnmodifiedSimpleArea","ObligatedAmountIsProducts","ObligatedAmountIsServices","ObligatedAmountIsRnD","MaxOfIsPossibleSoftwareEngineering")

# TempList<-TempList[TempList %in% names(CompleteContracts)]
# CompleteContracts<-subset(CompleteContracts,select=-c(PlatformPortfolio,
#                                                       UnmodifiedPlatformPortfolio,
#                                                       SimpleArea,UnmodifiedSimpleArea ))

CompleteContracts<-subset(CompleteContracts,select=-c(
    UnmodifiedProductOrServiceArea,
    ProductOrServiceArea,
    ObligatedAmountIsProducts,
    ObligatedAmountIsServices,
    ObligatedAmountIsRnD,
    ObligatedAmountIsLand,
    ObligatedAmountIsVessel,
    ObligatedAmountIsOtherPP,
    ObligatedAmountIsAir,
    ObligatedAmountIsEnC,
    ObligatedAmountIsFRSnC,
    ObligatedAmountIsMnS,
    ObligatedAmountIsWnA
    
    
    ))


```


```{r CompetitionVehicle}
#data\\defense_contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractUnmodifiedCompetitionvehicleCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )

#defense_contract_SP_ContractCompetitionVehicleCustomer.csv
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractCompetitionVehicleCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)

CompleteContracts$UnmodifiedNumberOfOffersReceived<-FactorToNumber(CompleteContracts$UnmodifiedNumberOfOffersReceived)

CompleteContracts$NumberOfOffersReceived<-FactorToNumber(CompleteContracts$NumberOfOffersReceived)


NAnumberOfOffers<-is.na(CompleteContracts$UnmodifiedNumberOfOffersReceived)&
    !is.na(CompleteContracts$NumberOfOffersReceived)
CompleteContracts$UnmodifiedNumberOfOffersReceived[NAnumberOfOffers]<-
    CompleteContracts$NumberOfOffersReceived[NAnumberOfOffers]
rm(NAnumberOfOffers)

CompleteContracts$qOffers <- cut2(CompleteContracts$NumberOfOffersReceived,cuts=c(1,2,3,5))

if(is.numeric(CompleteContracts$IsIDV)){
    CompleteContracts$IsIDV<-factor(CompleteContracts$IsIDV,levels=c(0,1),labels=c("Def/Pur","IDV"))
    }

CompleteContracts<-subset(CompleteContracts,select=-c(
#     UnmodifiedIsFullAndOpen,
    UnmodifiedIsOnlyOneSource,
    UnmodifiedIsFollowonToCompetedAction,
#     Unmodifiedmultipleorsingleawardidc,
#     Unmodifiedaddmultipleorsingawardidc,
    IsFullAndOpen,
    IsFollowonToCompetedAction
#     multipleorsingleawardidc,
#     AddMultipleOrSingleAwardIDC
    )
    )

```

```{r SubCustomer}
CompleteContracts<-read_and_join(Path
                                 ,"Defense_Contract_SP_ContractDefenseSubCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)


CompleteContracts$ObligatedAmountIsArmy<-FactorToNumber(CompleteContracts$ObligatedAmountIsArmy)
    
CompleteContracts$ObligatedAmountIsNavy<-FactorToNumber(CompleteContracts$ObligatedAmountIsNavy)

CompleteContracts$ObligatedAmountIsAirForce<-FactorToNumber(CompleteContracts$ObligatedAmountIsAirForce)
    
CompleteContracts$ObligatedAmountIsOtherDoD<-FactorToNumber(CompleteContracts$ObligatedAmountIsOtherDoD)
    
CompleteContracts$pIsArmy <- CompleteContracts$ObligatedAmountIsArmy/CompleteContracts$Action.Obligation
CompleteContracts$pIsArmy[is.nan(CompleteContracts$pIsArmy)|is.infinite(CompleteContracts$pIsArmy)|is.na(CompleteContracts$ObligatedAmountIsArmy)] <- 0

CompleteContracts$pIsNavy <- CompleteContracts$ObligatedAmountIsNavy/CompleteContracts$Action.Obligation
CompleteContracts$pIsNavy[is.nan(CompleteContracts$pIsNavy)|is.infinite(CompleteContracts$pIsNavy)|is.na(CompleteContracts$ObligatedAmountIsNavy)] <- 0

CompleteContracts$pIsAirForce <- CompleteContracts$ObligatedAmountIsAirForce/CompleteContracts$Action.Obligation
CompleteContracts$pIsAirForce[is.nan(CompleteContracts$pIsAirForce)|is.infinite(CompleteContracts$pIsAirForce)|is.na(CompleteContracts$ObligatedAmountIsAirForce)] <- 0

CompleteContracts$pIsOtherDoD <- CompleteContracts$ObligatedAmountIsOtherDoD/CompleteContracts$Action.Obligation
CompleteContracts$pIsOtherDoD[is.nan(CompleteContracts$pIsOtherDoD)|is.infinite(CompleteContracts$pIsOtherDoD)|is.na(CompleteContracts$ObligatedAmountIsOtherDoD)] <- 0


CompleteContracts<-subset(CompleteContracts,select=-c(
    ObligatedAmountIsArmy,
    ObligatedAmountIsNavy,
    ObligatedAmountIsAirForce,
    ObligatedAmountIsOtherDoD
    )
    )

names(CompleteContracts)


```



```{r DetailsRnD}
#defense_Contract_SP_ContractDetailsR&DCustomer.csv
# CompleteContracts<-read_and_join(Path
#                                  ,"defense_Contract_SP_ContractDetailsR&DCustomer.csv"
#                                  ,CompleteContracts
#                                  ,"data\\"
#                                  ,by="CSIScontractID"
#                                  )
#CompleteContracts<-standardize_variable_names(Path,CompleteContracts)
# subset(CompleteContracts,select=-c("isAnyRnD1to5","obligatedAmountRnD1to5","firstSignedDateRnD1to5","UnmodifiedRnD1to5"))
# CompleteContracts<-CompleteContracts[,!names(CompleteContracts) %in% c("isAnyRnD1to5","obligatedAmountRnD1to5","firstSignedDateRnD1to5","UnmodifiedRnD1to5")]
```


```{r Pricing}
#defense_contract_SP_ContractPricingCustomer
CompleteContracts<-read_and_join(Path
                                 ,"defense_contract_SP_ContractPricingCustomer.csv"
                                 ,CompleteContracts
                                 ,"data\\"
                                 ,by="CSIScontractID"
                                 )
CompleteContracts<-standardize_variable_names(Path,CompleteContracts)


CompleteContracts$ObligatedAmountIsFixedPrice<-FactorToNumber(CompleteContracts$ObligatedAmountIsFixedPrice)

CompleteContracts$ObligatedAmountIsCostBased<-FactorToNumber(CompleteContracts$ObligatedAmountIsCostBased)
    
CompleteContracts$ObligatedAmountIsCombination<-FactorToNumber(CompleteContracts$ObligatedAmountIsCombination)
    



CompleteContracts$pIsFixedPrice <- CompleteContracts$ObligatedAmountIsFixedPrice/CompleteContracts$Action.Obligation
CompleteContracts$pIsFixedPrice[is.nan(CompleteContracts$ObligatedAmountIsFixedPrice)|is.na(CompleteContracts$ObligatedAmountIsFixedPrice)] <- 0

CompleteContracts$pIsCostBased <- CompleteContracts$ObligatedAmountIsCostBased/CompleteContracts$Action.Obligation
CompleteContracts$pIsCostBased[is.nan(CompleteContracts$ObligatedAmountIsCostBased)|is.na(CompleteContracts$ObligatedAmountIsCostBased)] <- 0

CompleteContracts$pIsCombination <- CompleteContracts$ObligatedAmountIsCombination/CompleteContracts$Action.Obligation
CompleteContracts$pIsCombination[is.nan(CompleteContracts$ObligatedAmountIsCombination)|is.na(CompleteContracts$ObligatedAmountIsCombination)] <- 0



CompleteContracts$FixedOrCost[CompleteContracts$pIsFixedPrice>0  |
                                  CompleteContracts$pIsCostBased>0 | 
                                  CompleteContracts$pIsCombination>0]<-"Combination or Other"

CompleteContracts$FixedOrCost[CompleteContracts$pIsFixedPrice>=0.95|(CompleteContracts$IsFixedPrice==1 & (CompleteContracts$pIsCombination<=0.05 | is.na(CompleteContracts$pIsCombination)))]<-"Fixed-Price"
CompleteContracts$FixedOrCost[CompleteContracts$pIsCostBased>=0.95|(CompleteContracts$IsCostBased==1 & (CompleteContracts$pIsCombination<=0.05 | is.na(CompleteContracts$pIsCombination)))]<-"Cost-Based"
CompleteContracts$FixedOrCost<-factor(CompleteContracts$FixedOrCost,levels=c("Fixed-Price","Cost-Based","Combination or Other"))


CompleteContracts<-subset(CompleteContracts,select=-c(
#     TypeOfContractPricing,
    UnmodifiedTypeOfContractPricing,
    ObligatedAmountIsFixedPrice,
#     IsFixedPrice,
    UnmodifiedIsFixedPrice,
    ObligatedAmountIsCostBased,
#     IsCostBased,
    UnmodifiedIsCostBased,
    ObligatedAmountIsCombination,
#     IsCombination,
    UnmodifiedIsCombination,
    ObligatedAmountIsIncentive,
#     IsIncentive,
    UnmodifiedIsIncentive
#     pIsFixedPrice,
#     pIsCostBased,
#     pIsCombination                 
    )
    )
```

```{r PostApply}
# debug(apply_lookups)


CompleteContracts<-apply_lookups(Path,CompleteContracts)

NASimpleArea<-(CompleteContracts$SimpleArea=="Mixed or Unlabeled" | is.na(CompleteContracts$SimpleArea))&
    !is.na(CompleteContracts$UnmodifiedSimpleArea) & CompleteContracts$UnmodifiedSimpleArea!="NULL"
CompleteContracts$SimpleArea[NASimpleArea]<-CompleteContracts$UnmodifiedSimpleArea[NASimpleArea]
CompleteContracts$SimpleArea[CompleteContracts$SimpleArea=="Mixed or Unlabeled" & CompleteContracts$pIsProducts>0.5]<-"Products"
CompleteContracts$SimpleArea[CompleteContracts$SimpleArea=="Mixed or Unlabeled" & CompleteContracts$pIsServices>0.5]<-"Services"
CompleteContracts$SimpleArea[CompleteContracts$SimpleArea=="Mixed or Unlabeled" & CompleteContracts$pIsRnD>0.5]<-"R&D"


CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsLand>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Land Vehicles"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsVessel>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Ships & Submarines"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsAir>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Aircraft and Drones"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsOtherPP>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Other"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsWnA>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Weapons and Ammunition"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsMnS>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Missile and Space Systems"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsEnC>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Electronics and Communications"
CompleteContracts$PlatformPortfolio.sum[CompleteContracts$pIsFRSnC>=0.75&
                                            CompleteContracts$PlatformPortfolio.sum=="Unlabeled"]<-"Facilities and Construction"


CompleteContracts$pChangeOrderUnmodifiedBaseAndAll<-CompleteContracts$ChangeOrderBaseAndAllOptionsValue/CompleteContracts$UnmodifiedContractBaseAndAllOptionsValue



#IsSomeCompetition Impute missing values when labeled entries have a consistent value.
NAisSomeCompetition<-(is.na(CompleteContracts$UnmodifiedIsSomeCompetition)|
                          CompleteContracts$UnmodifiedIsSomeCompetition=="Unlabeled")&
    (CompleteContracts$IsSomeCompetition!="Mixed or \nUnlabeled"&
         !is.na(CompleteContracts$IsSomeCompetition))
CompleteContracts$UnmodifiedIsSomeCompetition[NAisSomeCompetition]<-
    CompleteContracts$IsSomeCompetition[NAisSomeCompetition]
rm(NAisSomeCompetition)
# Add this later if you want not full & open
# CompleteContracts$Comp[CompleteContracts$UnmodifiedIsSomeCompetition=="No Comp."]<-"No Comp."
# CompleteContracts$Comp[CompleteContracts$UnmodifiedIsSomeCompetition=="Comp." & 
#                            CompleteContracts$UnmodifiedIsFullAndOpen=="Not Full & Open"]<-"Comp."
# CompleteContracts$Comp[CompleteContracts$UnmodifiedIsSomeCompetition=="Comp." & 
#                            CompleteContracts$UnmodifiedIsFullAndOpen=="Comp."]<-"Comp."
# CompleteContracts$Comp[CompleteContracts$UnmodifiedIsSomeCompetition=="Comp."]<-"Comp."


# CompleteContracts$Comp<-factor(CompleteContracts$Comp,
#                                levels=c("No Comp.","Comp.")
#                                )



if (all(levels(CompleteContracts$qOffers)==c("  1","  2","[  3,  5)","[  5,999]"))){
    CompleteContracts$qOffers<-factor(CompleteContracts$qOffers, 
                                   levels=c("  1","  2","[  3,  5)","[  5,999]"),
                                   labels=c("1","2","3-4","5+"),
                                   ordered=TRUE
                                   )
    }


CompleteContracts$qOffers[is.na(CompleteContracts$qOffers)&
                          !is.na(CompleteContracts$UnmodifiedIsSomeCompetition)&
                              CompleteContracts$UnmodifiedIsSomeCompetition=="No Comp."
                          ]<-"1"


if (all(levels(CompleteContracts$qCeiling)==c("[0.00e+00,1.50e+04)",
                                              "[1.50e+04,1.00e+05)",
                                              "[1.00e+05,1.00e+06)",
                                              "[1.00e+06,1.00e+07)",
                                              "[1.00e+07,7.50e+07)",
                                              "[7.50e+07,3.36e+12]"))){
    CompleteContracts$qCeiling<-factor(CompleteContracts$qCeiling, 
                                   
                                   levels=c("[0.00e+00,1.50e+04)",
                                              "[1.50e+04,1.00e+05)",
                                              "[1.00e+05,1.00e+06)",
                                              "[1.00e+06,1.00e+07)",
                                              "[1.00e+07,7.50e+07)",
                                              "[7.50e+07,3.36e+12]"),
                                   labels=c("[0,15k)",
                                            "[15k,100k)",
                                            "[100k,1m)",
                                            "[1m,10m)",
                                            "[10m,75m)",
                                            "[75m+]"),
                                   ordered=TRUE
                                   )
    }
             


if (all(levels(CompleteContracts$qDuration)==c("[    0,   61)",
                                               "[   61,  214)",
                                               "[  214,  366)",
                                               "[  366,  732)",
                                               "[  732,33192]"))){
    CompleteContracts$qDuration<-factor(CompleteContracts$qDuration, 
                                   
                                   levels=c("[    0,   61)",
                                               "[   61,  214)",
                                               "[  214,  366)",
                                               "[  366,  732)",
                                               "[  732,33192]"),
                                   labels=c("[0 months,~2 months)",
                                               "[~2 months,~7 months)",
                                               "[~7 months-~1 year]",
                                               "(~1 year,~2 years]",
                                               "(~2 years+]"),
                                   ordered=TRUE
                                   )
    }
             



if (all(levels(CompleteContracts$qLinked)==c("    0",
                                             "[    1,  750)",
                                             "[  750,67263]"))){
    CompleteContracts$qLinked<-factor(CompleteContracts$qLinked, 
                                   
                                   levels=c("    0",
                                             "[    1,  750)",
                                             "[  750,67263]"),
                                   labels=c("0",
                                             "[1,750)",
                                             "[750+]"),
                                   ordered=TRUE
                                   )
    }


CompleteContracts$UnmodifiedNumberOfOffersReceived[is.na(CompleteContracts$UnmodifiedNumberOfOffersReceived)&
                                                       !is.na(CompleteContracts$UnmodifiedIsSomeCompetition)&
                                                       CompleteContracts$UnmodifiedIsSomeCompetition=="No Comp."
                                                   ]<-1





CompleteContracts$SingleOffer<-factor(CompleteContracts$UnmodifiedNumberOfOffersReceived==1,
                                      levels=c(TRUE,FALSE),
                                      labels=c("Single","Multi")
                                      )

CompleteContracts$SingleOffer[is.na(CompleteContracts$UnmodifiedNumberOfOffersReceived)]<-NA

CompleteContracts$SubCustomer.sum[CompleteContracts$pIsArmy>=0.95&
                                      CompleteContracts$SubCustomer.sum=="Uncategorized"]<-"Army"
CompleteContracts$SubCustomer.sum[CompleteContracts$pIsNavy>=0.95&
                                      CompleteContracts$SubCustomer.sum=="Uncategorized"]<-"Navy"
CompleteContracts$SubCustomer.sum[CompleteContracts$pIsAirForce>=0.95&
                                      CompleteContracts$SubCustomer.sum=="Uncategorized"]<-"Air Force"
CompleteContracts$SubCustomer.sum[CompleteContracts$pCustomer=="Defense"&
                                      CompleteContracts$SubCustomer.sum=="Uncategorized"]<-"Other DoD"
CompleteContracts$SubCustomer.sum[CompleteContracts$pIsArmy+CompleteContracts$pIsNavy+
                                      CompleteContracts$pIsAirForce+CompleteContracts$pIsOtherDoD>0.5&
                                      CompleteContracts$SubCustomer.sum=="Uncategorized"]<-"Other DoD"


CompleteContracts$SubCustomer.sum[
    CompleteContracts$SubCustomer.sum=="Uncategorized"&CompleteContracts$UnmodifiedSubCustomer %in% 
        c("Army", "Navy", "Air Force","Other DoD")]<-
    CompleteContracts$UnmodifiedSubCustomer[CompleteContracts$SubCustomer.sum==
                                                "Uncategorized"&CompleteContracts$UnmodifiedSubCustomer %in% 
                                                c("Army", "Navy", "Air Force","Other DoD")]


CompleteContracts$SimpleVehicle<-NA
CompleteContracts$SimpleVehicle[CompleteContracts$AwardOrIDVcontractActionType %in% c("Definitive Contract",
                                                                       "Purchase Order")]<-"Def/Pur"
CompleteContracts$SimpleVehicle[CompleteContracts$AwardOrIDVcontractActionType 
                                %in% c("Basic Ordering Agreement",
                                       "Blanket Purchase Agreement",
                                       "Federal Supply Schedule",
                                       "Government Wide Acquisition Contract")]<-"Other IDV"
CompleteContracts$SimpleVehicle[CompleteContracts$AwardOrIDVcontractActionType == "Letter Contract"]<-"Letter"
CompleteContracts$SimpleVehicle[CompleteContracts$AwardOrIDVcontractActionType %in%
                                    c("Indefinite Delivery Contract",
                                      "Delivery Order")]<-
    as.character(CompleteContracts$multipleorsingleawardidc[CompleteContracts$AwardOrIDVcontractActionType %in%
                                    c("Indefinite Delivery Contract",
                                      "Delivery Order")])

CompleteContracts$SimpleVehicle<-factor(CompleteContracts$SimpleVehicle)
summary(CompleteContracts$SimpleVehicle)
str(CompleteContracts$SimpleVehicle)

summary(CompleteContracts[is.na(CompleteContracts$SimpleVehicle),"AwardOrIDVcontractActionType"])



CompleteContracts$SoftwareEng<-factor(CompleteContracts$MaxOfIsPossibleSoftwareEngineering,
                                      levels=c(0,1),
                                      labels=c("Not Software Eng.","Possible Software Eng.")
                                      )

CompleteContracts$SoftwareEng[is.na(CompleteContracts$SoftwareEng)&
                                  !is.na(CompleteContracts$SimpleArea)]<-"Not Software Eng."


CompleteContracts$UCA<-factor(CompleteContracts$MaxOfIsUndefinitizedAction,
                                      levels=c(0,1),
                                      labels=c("Not UCA","UCA")
                                      )
CompleteModel$SubCustomer.sum<-droplevels(CompleteModel$SubCustomer.sum)


```


```{r Output}
CompleteModel<-subset(CompleteContracts,select=c(IsIDV,
    FixedOrCost,
    UnmodifiedIsSomeCompetition,
    #                         Comp,
    qLinked,
    SubCustomer.sum,
    PlatformPortfolio.sum,
    AnyInternational,
    SimpleArea,
    qCeiling,
    qDuration,
    SingleOffer,
    qOffers,
    SimpleVehicle,
    IsTerminated,
    SoftwareEng,
    UCA
    )
    )
# 

colnames(CompleteModel)[colnames(CompleteModel)=="SubCustomer.sum"]<-"Who"
colnames(CompleteModel)[colnames(CompleteModel)=="UnmodifiedIsSomeCompetition"]<-"Comp"
colnames(CompleteModel)[colnames(CompleteModel)=="PlatformPortfolio.sum"]<-"What"
colnames(CompleteModel)[colnames(CompleteModel)=="IsIDV"]<-"IDV"
colnames(CompleteModel)[colnames(CompleteModel)=="FixedOrCost"]<-"FxCb"
colnames(CompleteModel)[colnames(CompleteModel)=="AnyInternational"]<-"Intl"
colnames(CompleteModel)[colnames(CompleteModel)=="SimpleArea"]<-"PSR"
colnames(CompleteModel)[colnames(CompleteModel)=="qCeiling"]<-"Ceil"
colnames(CompleteModel)[colnames(CompleteModel)=="qLinked"]<-"Link"
colnames(CompleteModel)[colnames(CompleteModel)=="qDuration"]<-"Dur"
# colnames(CompleteModel)[colnames(CompleteModel)=="SingleOffer"]<-"One"
colnames(CompleteModel)[colnames(CompleteModel)=="qOffers"]<-"Offr"
colnames(CompleteModel)[colnames(CompleteModel)=="IsTerminated"]<-"Term"
colnames(CompleteModel)[colnames(CompleteModel)=="SoftwareEng"]<-"Soft"
colnames(CompleteModel)[colnames(CompleteModel)=="SimpleVehicle"]<-"Veh"


CompleteModel$Intl<-droplevels(CompleteModel$Intl)
CompleteModel$PSR<-droplevels(CompleteModel$PSR)
CompleteModel$Who<-droplevels(CompleteModel$Who)
CompleteModel$What<-droplevels(CompleteModel$What)

summary(CompleteModel)

summary(subset(CompleteModel,is.na(Offr)))
summary(subset(CompleteContracts,is.na(qOffers)))
summary(subset(CompleteContracts,is.na(FixedOrCost)&IsFixedPrice==1))
write.table(CompleteModel
            ,file=paste("data\\defense_contract_CSIScontractID_model.csv"
                        ,sep=""
                        )
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
            )

```



```{r Detailed}
CompleteModelAndDetail<-subset(CompleteContracts,select=c(CSIScontractID,
    IsIDV,
    FixedOrCost,
    UnmodifiedIsSomeCompetition,
    #                                 Comp,
    qLinked,
    SubCustomer.sum,
    PlatformPortfolio.sum,
    AnyInternational,
    SimpleArea,
    qCeiling,
    qDuration,
    SingleOffer,
    qOffers,
    IsIDV,
    SoftwareEng,
    UCA,
        SimpleVehicle,
    UnmodifiedNumberOfOffersReceived,
    IsTerminated,
    UnmodifiedContractBaseAndAllOptionsValue,
    SumOfisChangeOrder,
    pChangeOrderUnmodifiedBaseAndAll,
    pChangeOrderObligated,
    UnmodifiedDays
    Action.Obligation
    )
    )
# 
    names(CompleteContracts)
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="SubCustomer.sum"]<-"Who"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="UnmodifiedIsSomeCompetition"]<-"Comp"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="PlatformPortfolio.sum"]<-"What"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="IsIDV"]<-"IDV"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="FixedOrCost"]<-"FxCb"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="AnyInternational"]<-"Intl"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="SimpleArea"]<-"PSR"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="qCeiling"]<-"Ceil"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="qLinked"]<-"Link"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="qDuration"]<-"Dur"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="SingleOffer"]<-"One"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="qOffers"]<-"Offr"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="IsTerminated"]<-"Term"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="SimpleVehicle"]<-"Veh"
colnames(CompleteModelAndDetail)[colnames(CompleteModelAndDetail)=="SoftwareEng"]<-"Soft"


write.table(CompleteModelAndDetail
            ,file=paste("data\\defense_contract_CSIScontractID_detail.csv"
                        ,sep=""
                        )
            #   ,header=TRUE
            , sep=","
            , row.names=FALSE
            , append=FALSE
            )

```